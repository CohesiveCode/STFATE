C     ******************************************************************
C     * DREDGED MATERIAL FATE... INSTANTANEOUS BOTTOM DUMP...       *
C     * Code extracted and reconstructed from PDF source.          *
C     * Original formatting was heavily fragmented.                 *
C     ******************************************************************

      PROGRAM DMF(INPUT,OUTPUT,TAPE5=INPUT,TAPE6=OUTPUT,TAPE7)
C
C     THIS IS DUMMY MAIN PROGRAM TO SET BLANK COMMON STORAGE POINTERS
C     FOR LONG TERM ARRAYS, SOLIDS ARRAY AND SMALL CLOUDS ARRAYS
C
         COMMON/DIMFN/ NS,NSP1,NVL,NSC
         COMMON A(1)
C
C     CDC ONLY
C     COMMON A (SET DIMENSION NEED)
C
         REWIND 7
         READ (5,15) NMAX,MMAX,NS,NVL,NSC
   15    FORMAT (16I5)
C     NMAX-LONG TERM ARRAY DIMENSION IN Z-DIRECTION
C     MMAX-LONG TERM ARRAY DIMENSION IN X-DIRECTION
C     NS-NUMBER OF SOLID FRACTIONS
C     NVL-NUMBER OF VELOCITY PLANES
C     NSC-MAXIMUM NUMBER OF SMALL CLOUDS ALLOWED
C
C     OTHERS
C
C     SET ARRAY POINTERS
         NSP1 = NS+1
         LDIM = NMAX * MMAX
         N1 = 1
C     X
         N2 = N1+LDIM
C     Z
         N3 = N2+LDIM
C     DEPTH
         N4 = N3+LDIM
C     ICODE
         N5 = N4+LDIM
C     CP
         N6 = N5+LDIM
C     THICKP
         N7 = N6+LDIM
C     TOPP
         N8 = N7+LDIM
C     SUM
         N9 = N8+LDIM
C     C
         N10 = N9+LDIM
C     THICK
         N11 = N10+LDIM
C     TOP
         N12 = N11+LDIM
C     ACCUM
         N13 = N12+LDIM
C     U
         N14 = N13+LDIM*NVL
C     W
         N15 = N14+LDIM*NVL
C     SS
         N16 = N15+600*NS
C     TSIDE
         N17 = N16+NSC
C     TTHK
         N18 = N17+NSC
C     TTOP
         N19 = N18+NSC
C     TMASS
         N20 = N19+NSC
C     TX
         N21 = N20+NSC
C     TZ
         NEED = N21+NSC
C
C     FIND PRESENT FIELD LENGTH, ADD LENGTH OF ARRAYS (NEED) AND REQUEST
C     NEW FIELD LENGTH
C
C     CDC ONLY
C     LENF = MEMGET(65B) + 1
C     NEWLEN = LENF+NEED
C     WRITE(6,25) NMAX,MMAX,NS,NVL,NSC,NEED
C  25 FORMAT(/////10X,39HSTORAGE ALLOCATION PARAMETERS FOLLOW.../10X,
C    1 4HNMAX,1X,4HMMAX,3X,2HNS,2X,3HNVL,2X,3HNSC,4X,4HNEED/10X,I3,2X
C    2 ,I3,4X,I2,1X,I3,2X,I3,2X,I6)
C     CALL XRFL(NEWLEN)
C     CDC ONLY
C
         CALL MAIN(A(N1),A(N2),A(N3),A(N4),A(N5),A(N6),A(N7),A(N8),A(N9),
     1    A(N10),A(N11),A(N12),A(N13),A(N14),A(N15),A(N16),A(N17),
     2    A(N18),A(N19),A(N20),A(N21),NMAX,MMAX)
         CALL EXIT
      END
      SUBROUTINE MAIN(X,Z,DEPTH,ICODE,CP,COUT,THICKP,TOPP,SUM,C,THICK,
     1 TOP,ACCUM,U,W,SS,TSIDE,TTHK,TTOP,TMASS,TX,TZ,NMAX,MMAX)
C
C     MAIN PROGRAM
C
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         DIMENSION COUT(NMAX,1),SUM(NMAX,1),C(NMAX,1),THICK(NMAX,1),
     1    TOP(NMAX,1),ACCUM(NMAX,1),X(NMAX,1),Z(NMAX,1),DEPTH(NMAX,1),
     2    ICODE(NMAX,1),CP(NMAX,1),THICKP(NMAX,1),TOPP(NMAX,1),
     3    U(NMAX,MMAX,1),W(NMAX,MMAX,1),SS(600,NS),TSIDE(1),TTHK(1),
     4    TTOP(1),TMASS(1),TX(1),TZ(1)
         COMMON/DPASS/ NPASS,MPASS
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/GUIDE2/ NIND,NLINE(150),MF(150),ML(150)
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/CLOUD/ T(600),CX(600),CY(600),CZ(600),CU(600),CV(600),
     1    CW(600),DENDIF(600),BC(600),AA(600),FC(600),VF
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GPI/ G,PI
         COMMON/CHECK/ TOTAL
         COMMON/LOST/ GONE
         COMMON/USERDT/ KEY4,DT1U,DT2U
         COMMON/GP/ IGCN,IGCL,IGLT,IPCN,IPCL,IPLT
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
         COMMON/P/ PRT
         LOGICAL PRT
         DIMENSION ID(8),TPRT(12)
C
         DATA G,PI /32.2,3.14159/
C     NON-ANSI
         DATA TPRT/12*0./
C     NON-ANSI
         DATA ITD/1/,(DC(I),I=1,6)/.1,.01,.001,.0001,.00001,1.E-30/
C     NON-ANSI
C
         NPASS = NMAX
         MPASS = MMAX
         CALL SECOND(T1)
         WRITE(6,5)
C
C
    5    FORMAT(1H1///10X,59HFATE OF DREDGED MATERIAL DEPOSITED IN AN ESTUA
     1   RY BY DUMPING
     2   )
C     READ EXECUTION MANAGEMENT PARAMETERS
         READ(5,15) KEY1,KEY2,KEY3,KEY4
         READ(5,15) IGCN,IGCL,IPCN,IPCL,IPLT
   15    FORMAT(16I5)
         WRITE(6,25) KEY1,KEY2,KEY3,KEY4,IGCN,IGCL,IPCN,IPCL,IPLT
   25    FORMAT(//10X,30HEXECUTION PARAMETERS FOLLOW.../10X,
     1    52HKEY1 KEY2 KEY3 KEY4 IGCN IGCL IPCN IPCL IPLT/7X,10I6)
C     READ ALPHAMERIC IDENTIFICATION FOR THIS RUN
         READ(5,35) ID
   35    FORMAT(8A10)
         WRITE(6,105) ID
  105    FORMAT(8(/),10X,8A10,////)
C     DEFINE ESTUARY GEOMETRY AND ARRAYS GOVERNING LONG TERM COMPUTATION
         CALL ESTGEO(DEPTH,ICODE,NMAX,MMAX)
C     READ DUMP LOCATION COORDINATES AND DENSITY STRUCTURE ...
C     ...ALSO NUMBER OF VELOCITY LAYERS AND LOG PROFILE INDICATOR
         CALL AMBC(DEPTH,NMAX)
C     READ TIME OF DUMP (W/R TO START OF TIDAL CYCLE), DURATION OF
C     SIMULATION, AND TIME STEP IN LONG TERM
         READ(5,45) TDUMP,TSTOP,DTL
   45    FORMAT(8E10.0)
         WRITE(6,125) TDUMP,TSTOP,DTL
  125    FORMAT(///10X,25HTIME PARAMETERS FOLLOW.../10X,15HTIME OF DUMP
     1   ,F10.2,35H SECONDS AFTER START OF TIDAL CYCLE/10X,
     2    25HDURATION OF SIMULATION,F10.2,19H SECONDS AFTER DUMP/10X,
     3    28HLONG TERM TIME STEP (DTL),F10.2,8H SECONDS,6(/))
         IF(KEY4.EQ.0) GOTO 124
         READ(5,45) DT1U,DT2U
         WRITE(6,119) DT1U,DT2U
  119    FORMAT(/////10X,40HINTEGRATION TIME STEPS SPECIFIED BY USER /10X
     1   ,14HIN DUMP, DT=,G14.5,5X,16HIN COLLAPSE, DT=,G14.5)
  124    CONTINUE
C
C
C     SET PRINTING TIMES ACCORDING TO IPLT
         IF(IPLT) 150,150,170
C
C
C     HERE TO SET DEFAULT PRINTING TIMES
  150    DTP = TSTOP/4.
         INC = DTP/DTL + .0001
         IF(INC.LT.1) INC=1
         DO 160 I=1,4
            DTP = FLOAT(INC)*DTL
  160    TPRT(I) = FLOAT(I)*DTP
         IF(TPRT(4).GT.TSTOP) TPRT(4)=TSTOP
         GOTO 180
C     HERE TO SET USER SPECIFIED PRINTING TIMES
  170    CONTINUE
         READ(5,45) (TPRT(I),I=1,IPLT)
C     READ INITIAL VELOCITY FIELD
  180    CALL UW(0.,U,W,NMAX,MMAX)
C     CONVECTIVE DESCENT...
         CALL DUMP(SS,U,W,DEPTH,NS)
         IND = NUTRL + IPLUNG
         IF(NTRIAL.EQ.5.AND.IND.EQ.0) GOTO 700
         IF(KEY2.EQ.1) GOTO 800
         IF(IPLUNG.EQ.1) GOTO 250
C     CHECK DENSITY GRADIENT AT CLOUD LOCATION
         NN=NROA-1
         DO 200 I=1,NN
            IF(CY(ISTEP).GE.Y(I).AND.CY(ISTEP).LE.Y(I+1)) DENGRA =
     1       (ROA(I+1)-ROA(I))/(Y(I+1)-Y(I))
  200    CONTINUE
         IF(DENGRA.GT.1.0E-10) GOTO 250
         WRITE(6,205)
  205    FORMAT(1H1,10X,56HDENSITY GRADIENT = 0, GO DIRECTLY TO LONG TERM
     1    DIFFUSION )
C     ....IF KEY2=2, TERMINATE COMPUTATION....
         IF(KEY2.EQ.2) GOTO 800
         GOTO 250
C     DYNAMIC COLLAPSE...
  250    CALL COLAPS(SS,U,W,DEPTH,NS)
         IF(NTRIAL.EQ.5.AND.NUTRL.NE.3) GOTO 700
         IF(KEY2.EQ.2) GOTO 800
C     LONG TERM DIFFUSION FOLLOWS.....
C     DETERMINE NUMBER OF COMPLETE TIDAL CYCLES AND FRACTION OF LAST
C     TIDAL CYCLE TO RUN
         TSUM = (TDUMP+TSTOP)/3600.
         NCYCLE = TSUM/25. + .0001
         XS = TDUMP+TSTOP - 25.*3600.*FLOAT(NCYCLE)
         IF(NCYCLE.EQ.0) NCYCLE=1
C
C
C     CLEAR SUM OF BOTTOM ACCUMULATION
         DO 260 M=1,MMAX
            DO 260 N=1,NMAX
  260    SUM(N,M)=0.
C
C     LOOP ON COMPONENTS
         DO 400 K=1,NSP1
C
C
C
C
C
            GONE=0.
            ETS=0.
            IF(K.EQ.NSP1.AND.KEY3.EQ.0) GOTO 400
            WRITE(6,265) PARAM(K)
  265       FORMAT(1H1//10X,38HBEGIN LONG TERM SIMULATION OF FATE OF ,A10)
C     CLEAR ARRAYS
            DO 270 M=1,MMAX
               DO 270 N=1,NMAX
                  C(N,M)=0.
                  THICK(N,M)=0.
                  TOP(N,M)=0.
                  ACCUM(N,M)=0.
  270       CONTINUE
C     DO BOOKKEEPING FOR MASS TRANSFER FROM SHORT TERM TO LONG TERM
            CALL BOOKS(K,SS,TSIDE,TTHK,TTOP,TMASS,TX,TZ,NS,DEPTH,ACCUM,U,W,
     1       NMAX,MMAX,NSC)
            INDPRT=1
            DO 300 ICYCLE=1,NCYCLE
               IFST=1
               ILST = 25.*3600./DTL + .0001
               IF(ICYCLE.EQ.1) IFST = TDUMP/DTL + .0001
               IF(IFST.LT.1) IFST=1
               IF(ICYCLE.EQ.NCYCLE) ILST = XS/DTL + .0001
               DO 300 IDTL=IFST,ILST
C     ETS IS ELAPSED TIME FROM DUMP (IN SECONDS)
C     UPDATE VELOCITIES
                  ETS = ETS+DTL
                  CALL UW(ETS,U,W,NMAX,MMAX)
C     SET PRINT INDICATOR PRT
                  PRT = .FALSE.
                  IF(ABS(ETS-TPRT(INDPRT)).GT..01) GOTO 280
                  PRT = .TRUE.
                  INDPRT = INDPRT+1
  280             CONTINUE
C     CALL ROUTINE TO MOVE AND DIFFUSE CLOUDS
                  CALL MAD(K,ETS,X,Z,U,W,C,THICK,TOP,DEPTH,ACCUM,CP,THICKP,TOPP,
     1             COUT,ICODE,TSIDE,TTHK,TTOP,TMASS,TX,TZ,NMAX,MMAX)
                  IF(TOTAL.LT.1.0E-06) GOTO 310
  300       CONTINUE
C
C
C
            GOTO 330
  310       WRITE(6,315) PARAM(K),ETS
  315       FORMAT(///18H COMPUTATIONS FOR ,A10,15H TERMINATED AT,F10.2,
     1       48H SEC. ELAPSED TIME... MATERIAL SETTLED TO BOTTOM)
  330       CONTINUE
            IF(K.EQ.NSP1) GOTO 400
C     ....HERE SAVE TOTAL ACCUMULATION (ALL COMPONENTS)
            DO 340 M=1,MMAX
               DO 340 N=1,NMAX
  340       SUM(N,M)=SUM(N,M)+ACCUM(N,M)
C
C     PRINT FINAL ACCUMULATED VOLUME OF THIS COMPONENT
C
            DO 350 M=1,MMAX
               DO 350 N=1,NMAX
  350       COUT(N,M)=ACCUM(N,M)
            CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,2,ICODE)
C     PRINT FINAL THICKNESS ACCUMULATION FOR THIS COMPONENT
            C1 = (1.+VOIDS(K))/AREA
            DO 360 M=1,MMAX
               DO 360 N=1,NMAX
  360       COUT(N,M)=ACCUM(N,M)*C1
            CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,5,ICODE)
  400    CONTINUE
C
C
C     ...HERE PRINT TOTAL SOLID VOLUME (ALL COMPONENTS) ACCUMULATED
         WRITE(6,405)
  405    FORMAT(1H1,/////,10X,57HFINAL DISTRIBUTIONS OF TOTAL SETTLED MATER
     1   IAL FOLLOW.....
     2   )
         DO 410 M=1,MMAX
C
C
            DO 410 N=1,NMAX
  410    COUT(N,M) = SUM(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,6,ICODE)
         C1 = (1.+BVOID)/AREA
         DO 440 M=1,MMAX
            DO 440 N=1,NMAX
  440    COUT(N,M) = SUM(N,M)*C1
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,7,ICODE)
         IF(KEY3.EQ.0) GOTO 800
C     PRINT FINAL FLUID CONCENTRATIONS
         DO 450 M=1,MMAX
            DO 450 N=1,NMAX
  450    COUT(N,M)=C(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(NSP1),ETS,1,ICODE)
         DO 460 M=1,MMAX
            DO 460 N=1,NMAX
  460    COUT(N,M) = TOP(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(NSP1),ETS,3,ICODE)
         DO 470 M=1,MMAX
            DO 470 N=1,NMAX
  470    COUT(N,M)=THICK(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(NSP1),ETS,4,ICODE)
         WRITE(6,505) TRACER,CINIT,CBACK
  505    FORMAT(1H1/////10X,74HDILUTION TIMES FOR CONSERVATIVE TRACER IN
     1   INITIAL FLUID FRACTION FOLLOW...//10X,10HTRACER IS ,A10,28H,
     2    INITIAL CONCENTRATION IS,G15.7,36H MG/L, BACKGROUND
     3    CONCENTRATION IS,G15.7,5H MG/L )
         ITD=ITD-1
         DO 530 I=1,ITD
            IDL = 1./DC(I) + .001
            WRITE(6,515) IDL,TD(I)
  515       FORMAT(10X,12HDILUTION IS,I6,13H TO 1 WITHIN,F10.3,19H SECONDS
     1       AFTER DUMP)
  530    CONTINUE
         WRITE(6,535)
  535    FORMAT(//10X,54HDILUTION TIMES ARE FOR POINT OF MAXIMUM
     1    CONCENTRATION.)
         GOTO 800
  700    WRITE(6,705)
  705    FORMAT(//49H FIFTH SOLUTION TRIAL NOT SATISFACTORY--CALL EXIT)
         CALL EXIT
  800    CALL SECOND(T2)
         T3=T2-T1
         WRITE(6,805) T3
  805    FORMAT(27H1RUN COMPLETED, CPU TIME =,F7.3,5H SEC,)
         RETURN
      END
      SUBROUTINE ESTGEO(DEPTH,ICODE,NMAX,MMAX)
C
C     ROUTINE TO DEFINE ESTUARY GEOMETRY AND CODED ARRAY
C
         DIMENSION DEPTH(NMAX,1),ICODE(NMAX,1)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/GUIDE2/ NIND,NLINE(150),MF(150),ML(150)
C
C     READ GRID SPACE STEP
         READ(5,45) DX
   45    FORMAT(8E10.0)
         WRITE(6,65) NMAX,MMAX,DX
   65    FORMAT(10X,56HNUMBER OF LONG TERM GRID POINTS IN Z-DIRECTION
     1   (NMAX) =,I3//10X,
     2    56HNUMBER OF LONG TERM GRID POINTS IN X-DIRECTION (MMAX) =,
     3    I3//10X,20HGRID SPACING (DX) =,F12.5)
C
C     SET CONSTANTS
         DXH=DX*0.5
         DXR=1./DX
         AREA=DX**2
C
C     READ DEPTHS
         DO 10 M=1,MMAX
C
C
   10    READ(5,15) (DEPTH(N,M),N=1,NMAX)
   15    FORMAT(16F5.0)
C
C     GENERATE CODED ARRAY
         IWPT=0
         DO 20 M=1,MMAX
            DO 20 N=1,NMAX
               ICODE(N,M)=1
               IF(DEPTH(N,M).LE.0.) ICODE(N,M)=2
               IF(ICODE(N,M).EQ.2) GOTO 19
               IF(N.EQ.1.OR.N.EQ.NMAX.OR.M.EQ.1.OR.M.EQ.MMAX) ICODE(N,M)=3
   19          IF(ICODE(N,M).EQ.1) IWPT=IWPT+1
   20    CONTINUE
C     GENERATE ARRAYS GOVERNING CALCULATIONS
         NIND=0
         DO 100 N=1,NMAX
            DO 100 M=1,MMAX
               IF(ICODE(N,M).NE.1) GOTO 100
               IF(ICODE(N,M-1).EQ.1) GOTO 50
C
C
C     HERE TO START A LINE OF COMPUTATION
               NIND = NIND+1
               IF(NIND.LT.151) GOTO 40
               WRITE(6,28)
   28          FORMAT(//2X,111HARRAYS IN COMMON BLOCK/GUIDE2/ FILLED...
     1          CALL EXIT...USER SHOULD INCREASE DIMENSIONS AND CHANGE
     2          CHECK STATEMENT)
               CALL EXIT
   40          CONTINUE
               NLINE(NIND)=N
               MF(NIND)=M
               GOTO 100
   50          IF(ICODE(N,M+1).EQ.1) GOTO 100
C     HERE TO END A LINE OF COMPUTATION
               ML(NIND)=M
  100    CONTINUE
C     PRINT ARRAYS
         WRITE(6,115)
  115    FORMAT(1H1,10X,21HDEPTH GRID FOLLOWS.../)
         NCP = NMAX/24+1
         IF(((NCP-1)*24).EQ.NMAX) NCP=NCP-1
         IN2=0
         DO 130 IP=1,NCP
            IN1=IN2+1
            IN2=IN2+24
            IF(NMAX.LT.IN2) IN2=NMAX
            WRITE(6,117) (N,N=IN1,IN2)
  117       FORMAT(2X,4HM(N=,I2,2H),24I5/)
            DO 120 M=1,MMAX
               WRITE(6,119) M,(DEPTH(N,M),N=IN1,IN2)
  119          FORMAT(1X,I2,1X,24F5.0)
  120       CONTINUE
            IF(IP.LT.NCP) WRITE(6,122)
  122       FORMAT(1H1//)
  130    CONTINUE
         WRITE(6,135)
  135    FORMAT(1H1,10X,22HCODED ARRAY FOLLOWS.../)
         NCP=NMAX/60
         IF(NCP.LT.1) NCP=1
         IN2=0
         DO 150 IP=1,NCP
            IN1=IN2+1
            IN2=IN2+60
            IF(NMAX.LT.IN2) IN2=NMAX
            WRITE(6,137) IN1,IN2
  137       FORMAT(10X,14HRANGE OF N IS,I3,4H TO,I3/)
            DO 140 M=1,MMAX
               WRITE(6,139) (ICODE(N,M),N=IN1,IN2)
  139          FORMAT(1X,60I2)
  140       CONTINUE
            IF(IP.LT.NCP) WRITE(6,122)
  150    CONTINUE
         WRITE(6,155) IWPT
  155    FORMAT(////10X,39HNUMBER OF GRID POINTS WITHIN ESTUARY =,I5/1H1)
         RETURN
      END
      SUBROUTINE AMBC(DEPTH,NMAX)
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         DIMENSION DEPTH(NMAX,1)
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/VSPECS/ IFORM,DU1,DU2,UU1,UU2,DW1,DW2,WW1,WW2,DL1,DL2
C     READ X AND Z COORDINATES (W/R TO LONG TERM GRID, IN FEET) OF
C     BARGE POSITION
         READ(5,5) XBARGE,ZBARGE
    5    FORMAT(8E10.0)
C     ....READ NUMBER OF POINTS WHERE AMBIENT DENSITY SPECIFIED....
         READ(5,15) NROA
   15    FORMAT(16I5)
C     ....READ VERTICAL DISTANCES FROM FREE SURFACE WHERE DENSITY SPECIFIED....
         READ(5,5) (Y(I),I=1,NROA)
C     ....READ AMBIENT DENSITIES....
         READ(5,5) (ROA(I),I=1,NROA)
         WRITE(6,25) XBARGE,ZBARGE
   25    FORMAT(1H1,10X,20HBARGE COORDINATES.../10X,14HXBARGE (FT) =,G12.4
     1   ,3X,14HZBARGE (FT) =,G12.4)
C     ....WRITE AMBIENT DENSITY PROFILE....
         WRITE(6,35)
   35    FORMAT(////29X,24H---AMBIENT CONDITIONS---)
         DO 60 J=1,NROA,8
            JJ=J+7
            IF(JJ.GE.NROA) JJ=NROA
            WRITE(6,45) (Y(I),I=J,JJ)
   45       FORMAT(//15X,10HDEPTH (FT),5X,8G12.4)
            WRITE(6,55) (ROA(I),I=J,JJ)
   55       FORMAT(9X,7HAMBIENT/9X,15HDENSITY (GM/CC),5X,8G12.4)
   60    CONTINUE
C     ....CONVERT AMBIENT DENSITY FROM UNITS OF GM/CC TO SLUGS/CUFT...
         DO 70 I=1,NROA
   70    ROA(I) = ROA(I)*1.94
C     SETH EQUAL TO DEPTH INTERPOLATED FROM FOUR GRID POINTS SURROUNDING BARGE
         CALL DINT(XBARGE,ZBARGE,H,DEPTH,NMAX)
         WRITE(6,75) H
   75    FORMAT(///10X,44HINTERPOLATED DEPTH AT DUMP COORDINATES, H =,
     1    G12.4,4H FT.)
         WRITE(6,95)
   95    FORMAT(/10X,10(8H--------))
         READ(5,165) IFORM
  165    FORMAT(16I5)
         IF(IFORM.GE.4) READ(5,5) DU1,DU2,UU1,UU2,DW1,DW2,WW1,WW2
         GOTO (430,440,450,460),IFORM
  430    WRITE(6,435)
  435    FORMAT(///10X,68HSINGLE VELOCITY PLANE USED WITH VELOCITIES
     1    CONSTANT IN THE VERTICAL )
         GOTO 480
  440    WRITE(6,445)
  445    FORMAT(///10X,53HSINGLE VELOCITY PLANE USED WITH LOGARITHMIC
     1    VELOCITY /10X,65HDISTRIBUTION SUCH THAT VERTICAL AVERAGE
     2    EQUALS SPECIFIED VELOCITY )
         GOTO 480
  450    WRITE(6,455)
  455    FORMAT(///10X,96HTWO VELOCITY PLANES USED WITH STRAIGHT LINE
     1    INTERPOLATION (SEE FIGURE 6.2(C) FOR INTERPRETATION))
         GOTO 480
  460    WRITE(6,465) DU1,DU2,UU1,UU2,DW1,DW2,WW1,WW2
  465    FORMAT(///10X,73HTWO VELOCITY PROFILES SPECIFIED IN X AND Z
     1    DIRECTIONS FOR--QUICK LOOKS--/10X,63HDEPTH ASSUMED CONSTANT
     2    AND VELOCITIES CONSIDERED STEADY IN TIME/10X,
     3    37HVELOCITY PROFILE PARAMETERS FOLLOW.../10X,
     4    6HDU1 =,G11.3,1X,6HDU2 =,G11.3,1X,6HUU1 =,G11.3,
     5    1X,6HUU2 =,G11.3/10X,6HDW1 =,G11.3,1X,6HDW2 =,G11.3,1X,
     6    6HWW1 =,G11.3,1X,6HWW2 =,G11.3)
  480    CONTINUE
         RETURN
      END
      
      SUBROUTINE DUMP(SS,U,W,DEPTH,NS)
C
C     THREE-DIMENSIONAL AXI-SYMMETRIC INSTANTANEOUS RELEASE OF ENTIRE
C     LOAD FROM BARGE
C
         EXTERNAL DERIVD
         DIMENSION SS(600,NS), U(1), W(1), DEPTH(1)
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/CLOUD/ T(600),CX(600),CY(600),CZ(600),CU(600),CV(600),
     1    CW(600),DENDIF(600),BC(600),AA(600),FC(600),VF
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/GPI/ G,PI
         COMMON/SICOEF/ ALPHA,ALPHAO,ALPHAC,BETA,CDRAG,CFRIC,CD,CD1,CD2,
     1    CD3,CD4,CM,DINCR1,DINCR2,FRICTN,GAMA,F1
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         COMMON/DTEES/ DT,DT1,DT2
         COMMON/COL/ AO,IBED,FBED
         COMMON/SWITCH/ ITF
         COMMON/GP/ IGCN,IGCL,IGLT,IPCN,IPCL,IPLT
         COMMON/USERDT/ KEY4,DT1U,DT2U
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
         COMMON/DUMP1/ E(22)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         DIMENSION VORT(600),ACONC(12),SAVE(22)
         NTRIAL=0
C
         KV=1
         IBED=0
         ILEAVE=999
         NSP1=NS+1
C
C
C     ....HERE TO SET INITIAL CONDITIONS....
C
C
         READ(5,25) RB,DREL,CU(1),CV(1),CW(1),ROO,BVOID
         WRITE(6,125) RB,DREL,CU(1),CV(1),CW(1),ROO,BVOID
  125    FORMAT(1H1//10X,23HDISCHARGE PARAMETERS.,10X,
     1    30HINITIAL RADIUS OF CLOUD, RB =,G15.7/10X,
     2    40HINITIAL DEPTH OF CLOUD CENTROID, DREL =,G12.4/10X,
     3    35HINITIAL CLOUD VELOCITIES...CU(1) =,G12.4,3X,
     4    8HCV(1) =,G12.4,3X,8HCW(1) =,G12.4//10X,
     5    18HBULK PARAMETERS.../10X,15HDENSITY, ROO =,G15.7/10X,
     6    31HAGGREGATE VOIDS RATIO, BVOID =,G12.4)
         WRITE(6,135) NS
  135    FORMAT(5(/),10X,10HTHERE ARE,I2,34H SOLIDS, PARAMETERS FOLLOW...
     1    ....//10X,90HDESCRIPTION          DENSITY(GM/CC)
     2    CONCENTRATION(CUFT/CUFT)   FALL VELOCITY(FT/SEC)   VOIDS RATIO/)
         DO 150 K=1,NS
            READ(5,35) PARAM(K),ROAS(K),CS(K),VFALL(K),VOIDS(K)
   35       FORMAT(A10,7E10.0)
            WRITE(6,145) PARAM(K),ROAS(K),CS(K),VFALL(K),VOIDS(K)
  145       FORMAT(11X,A10,2X,G12.4,9X,G12.4,15X,G12.4,5X,G12.4)
  150    CONTINUE
         PARAM(NSP1) = 'FLUID'
         VFALL(NSP1) = 0.
C     NON-ANSI
C     CHECK CONSISTENCY OF PARAMETERS WITH NECESSARY MINIMUM FLUID DENSITY OF 1.
         CS(NSP1)=1.
         CIV = 2.*PI*RB**3/3.
         CIVS=CIV
         CIM=ROO*CIV
         DO 170 K=1,NS
C
            SV=CS(K)*CIVS
            SM=SV*ROAS(K)
            CS(NSP1)=CS(NSP1)-CS(K)
            CIV=CIV-SV
            CIM=CIM-SM
  170    CONTINUE
         FD=CIM/CIV
         WRITE(6,145) PARAM(NSP1),FD,CS(NSP1),VFALL(NSP1)
         IF(FD.GE.0.97) GOTO 190
         WRITE(6,185)
  185    FORMAT(//10X,44HFLUID DENSITY LESS THAN 0.97 GM/CC, CALL EXIT)
         CALL EXIT
  190    CONTINUE
C     READ INFO FOR DILUTION OF CHEMICAL TRACER
         READ(5,192) TRACER,CINIT,CBACK
  192    FORMAT(A10,2E10.0)
C     ....CONVERT UNITS FROM G/CC TO SLUGS/CUFT......
         DO 200 I=1,NS
            ROAS(I)=ROAS(I)*1.94
  200    CONTINUE
         ROO=ROO*1.94
C
         IF(KEY1.EQ.2) GOTO 70
C
C
C     ....HERE TO USE TETRA TECH COEFFICIENTS....
         WRITE(6,65)
C
C
C
C
   65    FORMAT(//////10X,37HUSE TETRA TECH SUGGESTED COEFFICIENTS)
         DINCR1=1.
         DINCR2=1.
         ALPHAO=0.235
         BETA=0.
         CM=1.
         CD=0.5
         CDRAG=1.
         GAMA=0.25
         CFRIC=.01
         CD3=.1
         CD4=1.
         ALPHAC=.001
         FRICTN=.01
         F1=0.1
         ALAMDA=.005
         AKYO=.05
         GOTO 80
C     ....HERE TO READ IN COEFFICIENTS....
   70    WRITE(6,75)
   75    FORMAT(//////10X,24HUSE READ IN COEFFICIENTS)
         READ(5,25) DINCR1,DINCR2
         READ(5,25) ALPHAO,BETA,CM,CD
         READ(5,25) GAMA,CDRAG,CFRIC,CD3,CD4,ALPHAC,FRICTN,F1
         READ(5,25) ALAMDA,AKYO
   25    FORMAT(8E10.0)
C     ....HERE TO WRITE COEFFICIENTS....
   80    WRITE(6,85) DINCR1,DINCR2
   85    FORMAT(10X,6HDINCR1,F10.4,7H DINCR2,F10.4)
         WRITE(6,95) ALPHAO,BETA,CM,CD
   95    FORMAT(10X,6HALPHAO,F10.4,5H BETA,F10.4,3H CM,F10.4,3H CD,F10.4)
         WRITE(6,105) GAMA,CDRAG,CFRIC,CD3,CD4,ALPHAC,FRICTN,F1
  105    FORMAT(10X,4HGAMA,5X,F5.2,3X,5HCDRAG,2X,F5.2,3X,5HCFRIC,1X,F5.3,
     1    2X,3HCD3,2X,F5.2,1X,3HCD4,1X,F5.2,1X,6HALPHAC,F10.4/10X,
     2    6HFRICTN,F10.4,1X,2HF1,F10.4)
         WRITE(6,115) ALAMDA,AKYO
  115    FORMAT(10X,6HALAMDA,F10.4,1X,4HAKYO,F10.4/)
C     ....SAVE AMBIENT DENSITY AT Y(1)....
         ROAA=ROA(1)
         C1=(ROO-ROA(1))/ROA(1)
         E1=(ROA(NROA)-ROA(1))/(H*ROA(1))
         FF=CV(1)/SQRT(G*C1*RB)
         EE1=E1*RB/C1
C
C     TOTAL NUMBER OF EQUATIONS
         NE=9+NS
C
C     LONG TERM DIFFUSION PARAMETER
         DIF = ALAMDA * DX**1.333333*DTL/DX**2
         IF(DIF.GT.0.2) DIF=.2
C
C     ....END OF INITIAL CONDITIONS....
C     ....SELECT TIME STEP FOR INTEGRATIONS....
         IF(ROA(NROA).NE.ROA(1)) GOTO 230
         IF(CV(1).NE.0.) GOTO 220
  210    DT=5.
         GOTO 250
  220    DT=0.01*RB
         GOTO 250
  230    IF(CV(1).EQ.0.) GOTO 210
C     CRITERION FROM CONDITION OF STRATIFICATION
         DT=.01*PI*FF/SQRT(EE1)
C     CRITERION FROM UNIFORM AMBIENT
         DT1 = .01*RB*FF * (1.+ALPHAO*H/RB)**2 / (CV(1)*2.)
         IF(DT-DT1) 250,240,240
  240    DT=DT1
C     INITIAL POSITION OF CLOUD CENTROID (W/R TO BARGE)
  250    E(1)=0.
C
C
C
C
C
C
         E(2)=DREL
         E(3)=0.
C     ....INITIAL MASS OF CLOUD....
         VOLUME = 2.*PI*RB**3/3.
         E(4) = ROO*VOLUME
C     ....INITIAL MOMENTA....
         CMMASS = CM*E(4)
         E(5) = CMMASS*CU(1)
         E(6) = CMMASS*CV(1)
         E(7) = CMMASS*CW(1)
C     ....INITIAL BUOYANCY....
         E(8) = (ROA(1)-ROO)*VOLUME
C     ....INITIAL VORTICITY....
         E(9)=RB*CV(1)*FLOAT(KV)
C     ....SUBTRACT VOLUME OF VARIOUS SOLID COMPONENTS FROM TOTAL WASTE
C     VOLUME, VF, AND PLACE IN E ARRAY. REMAINDER IN VF IS
C     VOLUME OF FLUID WASTE....
         VF = VOLUME
         DO 260 K=1,NS
            E(K+9)=CS(K)*VOLUME
  260    VF = VF-E(K+9)
         DO 270 I=1,NE
  270    SAVE(I)=E(I)
         ROSAV = ROO
         ALPHA = ALPHAO
         DINCR = DINCR1
         WRITE(6,295)
C
C
C
C
C
C
C
C
C
  295    FORMAT(1H1,10X,18HCONVECTIVE DESCENT///10X,
     1    34HCOMPUTATIONAL INDICATORS FOLLOW...//10X,6HNTRIAL,9X,2HDT,
     2    7X,6HIPLUNG,1X,5HNUTRL,1X,5HISTEP)
         IF(KEY4.EQ.1) DT=DT1U
C     ....HERE TO BEGIN A SOLUTION TRIAL....
  400    ROO=ROSAV
C     ....INCREMENT TRIAL NUMBER....
         NTRIAL=NTRIAL+1
C     ....INITIALIZE VARIABLES....
         T(1)=0.
         IY=1
         ISTEP=1
         NUTRL=0
         IPLUNG=0
         DO 410 I=1,NE
  410    E(I)=SAVE(I)
C     ....HERE TO BEGIN COMPUTATIONAL LOOP IN TIME....
C     STORE RESULTS FROM INITIAL CONDITIONS OR PREVIOUS COMPUTATION
C     IN APPROPRIATE ARRAYS....
  420    CX(ISTEP)=E(1)
         CY(ISTEP)=E(2)
         CZ(ISTEP)=E(3)
         VOLUME=(E(4)+E(8))/ROA(1)
         CMMASS = 1./(CM*E(4))
         CU(ISTEP)=E(5)*CMMASS
         CV(ISTEP)=E(6)*CMMASS
         CW(ISTEP)=E(7)*CMMASS
C     WHEN VORTICITY GOES TO ZERO, IT IS SET TO ZERO
         IF(E(9).LE.0.) E(9)=0.
         VORT(ISTEP)=E(9)
C     BC IS DIAMETER OF CLOUD
         AA(ISTEP)=(1.5*VOLUME/PI)**.333333
         BC(ISTEP)=2.*AA(ISTEP)
C     SS IS SOLID CONCENTRATION IN VOLUME RATIO
         DO 430 K=1,NS
  430    SS(ISTEP,K)=E(K+9)/VOLUME
C     FLUID CONCENTRATION
         FC(ISTEP)=VF/VOLUME
         CTRACE=(CINIT*VF+(VOLUME-VF)*CBACK)/VOLUME
         DR=CTRACE/CINIT
         IF(DR.GT.DC(ITD)) GOTO 460
         TD(ITD)=T(ISTEP)
         ITD=ITD+1
  460    CONTINUE
C     NEW OVERALL DENSITY OF WASTE CLOUD
         ROO=E(4)/VOLUME
C     INTERPOLATE FOR AMBIENT DENSITY AT VERTICAL POSITION E(2)
         ROAA = ROA(IY)+(E(2)-Y(IY))*(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
C     CONVERT DENSITY DIFFERENCE BACK TO GM/CC AND STORE IN DENDIF
C
C
C
         DENDIF(ISTEP)=(ROO-ROAA)*.51545
C
C     TEST FOR BOTTOM ENCOUNTER
         IF((CY(ISTEP)+3.*AA(ISTEP)/8.).GE.H) IPLUNG=1
C
C     TEST FOR LOOP EXIT
         IF(IPLUNG.EQ.1) GOTO 500
         IF(NUTRL.EQ.1) GOTO 500
         IF(ISTEP.GE.600) GOTO 500
C
C     SOLVE EQUATION SET FOR NEXT TIME STEP
         CALL RUNGS(DERIVD,NE,U,W,DEPTH)
         ISTEP=ISTEP+1
         T(ISTEP)=T(ISTEP-1)+DT
C
C
C
C
C
C
C
C
         GOTO 420
C     ....END OF LOOP IN TIME.....
C     PRINT OUT VARIABLES GUIDING JUST COMPLETED SOLUTION TRIAL
  500    WRITE(6,505) NTRIAL,DT,IPLUNG,NUTRL,ISTEP
  505    FORMAT(9X,I5,G16.8,2X,3I6)
C     ITF SAVES LAST TIME STEP OF DESCENT PHASE
         ITF=ISTEP
C     TEST FOR PROPER NUMBER OF TIME STEPS IN CONVECTIVE CALCULATIONS
         IF(ISTEP.LT.100.OR.ISTEP.GT.200) GOTO 510
         GOTO 520
  510    DT = DT*FLOAT(ISTEP)*DINCR/150.
C     IF FIFTH TRIAL COMPLETED, GO TO OUTPUT SECTION, IF NOT RETURN FOR
C     NEXT TRIAL
         IF(NTRIAL.GE.5) GOTO 520
         GOTO 400
C     ....HERE FOR PRINTED AND/OR GRAPHICAL OUTPUT....
  520    IF(IPCN.EQ.0) GOTO 600
C     ....HERE FOR PRINTOUT....
         WRITE(6,524)
  524    FORMAT(//10X,42HX AND Z ARE MEASURED W/R TO BARGE POSITION)
         WRITE(6,525)
  525    FORMAT(//8X,4HTIME,5X,1HX,7X,1HY,7X,1HZ,6X,1HU,6X,1HV,5X,1HW,6X,
     1    7HDEN-DIF,3X,6HRADIUS,1X,5HDIA.,2X,5HVORT.,3X,12HFLUID CONC.,
     2    10HSOLID-VOL,2X,13HCONCENTRATION)
         LINC=ISTEP/60
         IF(LINC.LT.1) LINC=1
         DO 560 J=1,ISTEP,LINC
            DO 530 K=1,NS
  530       ACONC(K) = 2.*PI*AA(J)**3*SS(J,K)/3.
            WRITE(6,535) T(J),CX(J),CY(J),CZ(J),CU(J),CV(J),CW(J),DENDIF(J),
     1       AA(J),BC(J),VORT(J),FC(J),ACONC(1),SS(J,1)
  535       FORMAT(4X,4F8.2,F6.2,F7.3,F6.2,E12.4,2F7.2,1X,F7.4,3F12.4)
            IF(NS.EQ.1) GOTO 560
            DO 540 K=2,NS
  540       WRITE(6,545) ACONC(K),SS(J,K)
  545       FORMAT(101X,2F12.4)
  560    CONTINUE
  600    IF(IGCN.EQ.0) GOTO 700
C     ....HERE FOR GRAPHING....
         ISTEP1=ISTEP+1
         T(ISTEP1)=2.*T(ISTEP)-T(ISTEP-1)
         CX(ISTEP1)=2.*CX(ISTEP)-CX(ISTEP-1)
         CZ(ISTEP1)=2.*CZ(ISTEP)-CZ(ISTEP-1)
         CY(ISTEP1)=0.
         AA(ISTEP1)=0.
         FC(ISTEP1)=0.
         CALL DRAW(T,T,T,T,CY,AA,CX,CZ,ISTEP1,1,4)
         IF(IGCN.EQ.1) GOTO 700
         DO 610 I=1,NS
  610    SS(ISTEP1,I)=0.
         NG=4
         IF(NS.LT.4) NG=NS
         CALL DRAW(T,T,T,T,SS(1,1),SS(1,2),SS(1,3),SS(1,4),ISTEP1,3,NG)
         IF(NS.LE.4) GOTO 700
         NG=4
         IF(NS.LT.8) NG=NS-4
         CALL DRAW(T,T,T,T,SS(1,5),SS(1,6),SS(1,7),SS(1,8),ISTEP1,4,NG)
         IF(NS.LE.8) GOTO 700
         NG=4
         IF(NS.LT.12) NG=NS-8
         CALL DRAW(T,T,T,T,SS(1,9),SS(1,10),SS(1,11),SS(1,12),ISTEP1,7,NG)
  700    CONTINUE
C
C
C
C     ....SHIFT DATA TO PREPARE FOR COLLAPSE PHASE....
         DT1=DT
         DO 730 K=1,NS
            I=NS-K
  730    E(I+11)=E(I+10)
         E(9)=AA(ISTEP)
         AO=AA(ISTEP)
         IF(IPLUNG.EQ.1) GOTO 720
         E(10)=0.
         RETURN
C     ....HERE IF CLOUD HAS HIT BOTTOM....
  720    E(10) = ROO*PI*E(9)**3*(2.666666*CV(ISTEP))/32.
         IBED=ISTEP
         RETURN
      END
      SUBROUTINE DERIVD(E,U,W,DEPTH)
C
C     ....CALLED FROM DUMP VIA RUNGS....
C
         DIMENSION E(22), U(1), W(1), DEPTH(1)
         COMMON/DPASS/ NPASS,MPASS
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         COMMON/A/ EP(22)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/GPI/ G,PI
         COMMON/SICOEF/ ALPHA,ALPHAO,ALPHAC,BETA,CDRAG,CFRIC,CD,CD1,CD2,
     1    CD3,CD4,CM,DINCR1,DINCR2,FRICTN,GAMA,F1
         COMMON/COL/ AO,IBED,FBED
         IF(E(2).GE.0.) GOTO 30
         WRITE(6,15)
   15    FORMAT(1X,51HDEPTH Y .LT. 0--CHANGE INPUT DATA TO ENSURE DESCENT)
         CALL EXIT
C
   30    CONTINUE
C     SET IY SO THAT CLOUD DEPTH E(2) IS BRACKETED BY Y(IY) AND Y(IY+1)
         IF(E(2).LE.Y(IY+1)) GOTO 40
         IY=IY+1
         GOTO 30
   40    IF(E(2)-Y(IY)) 50,100,100
C
   50    IY=IY-1
         GOTO 30
C     INTERPOLATE FOR AMBIENT DENSITY AT DEPTH OF CENTROID OF CLOUD...
  100    ROAA = ROA(IY)+(E(2)-Y(IY))*(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         CE = (ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         VOLUME=(E(4)+E(8))/ROA(1)
         ROO=E(4)/VOLUME
         IF(ROO.LE.ROAA) NUTRL=1
         B=(1.5*VOLUME/PI)**.333333
C
C
         XX=XBARGE+E(1)
C
C     DETERMINE HORIZONTAL VELOCITIES AT CLOUD
         ZZ=ZBARGE+E(3)
         CALL VEL(XX,E(2),ZZ,UA,WA,U,W,DEPTH,NPASS,MPASS)
         IF(E(9)) 110,110,120
  110    ALPHA=ALPHAO
         GOTO 200
  120    ALPHA=ALPHAO*SQRT(TANH((G*VOLUME*(ROO-ROAA)/(2.*PI*.16*ROO*
     1    E(9)**2*ALPHAO))**2))
C
C
C     MAIN COMPUTATIONS
  200    CMMASS=CM*E(4)
         UU=E(5)/CMMASS
         VV=E(6)/CMMASS
         WW=E(7)/CMMASS
         PHI=SQRT((UU-UA)**2+VV**2+(WW-WA)**2)
C     ENTRAINED VOLUME IS...
         ENTRV = 2.*PI*B**2*ALPHA*PHI
         EP(1)=UU
         EP(2)=VV
         EP(3)=WW
         EP(4)=ENTRV*ROAA
         DRAG=CD*ROAA*PI*B**2*PHI*.5
         EP(5)=ENTRV*ROAA*UA - DRAG*(UU-UA)*.5
         EP(6)=VOLUME*(ROO-ROAA)*G - DRAG*VV
         EP(7)=ENTRV*ROAA*WA - DRAG*(WW-WA)*.5
         EP(8)=ENTRV*(ROA(1)-ROAA)
         EP(9)=-3.*B**2*G*CE/ROA(1)
         DO 250 K=1,NS
            ABSWS=ABS(VFALL(K))
C     IF FALL VEL IS SMALLER THAN THE CONVECTIVE VEL. NO SETTLING OCCURS
            IF(ABSWS-ABS(VV)) 220,220,230
  220       BETAA=1.
            GOTO 240
  230       BETAA=BETA
  240       SETLV=PI*B**2*ABS(VFALL(K))*(1.-BETAA)*E(K+9)/VOLUME
            EP(4)=EP(4)-SETLV*(ROAS(K))
            EP(5)=EP(5)-SETLV*(ROAS(K))*UU
            EP(6)=EP(6)-SETLV*(ROAS(K))*VV
            EP(7)=EP(7)-SETLV*(ROAS(K))*WW
            EP(8)=EP(8)-SETLV*(ROA(1)-ROAS(K))
            EP(K+9)=-SETLV
  250    CONTINUE
         RETURN
      END
      SUBROUTINE COLAPS(SS,U,W,DEPTH,NS)
         EXTERNAL DERIVC
         DIMENSION SS(600,NS), U(1), W(1), DEPTH(1)
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/CLOUD/ T(600),CX(600),CY(600),CZ(600),CU(600),CV(600),
     1    CW(600),DENDIF(600),BC(600),AA(600),FC(600),VF
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/COL/ AO,IBED,FBED
         COMMON/DUMP1/ E(22)
         COMMON/GPI/ G,PI
         COMMON/SICOEF/ ALPHA,ALPHAO,ALPHAC,BETA,CDRAG,CFRIC,CD,CD1,CD2,
     1    CD3,CD4,CM,DINCR1,DINCR2,FRICTN,GAMA,F1
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         COMMON/DTEES/ DT,DT1,DT2
         COMMON/GP/ IGCN,IGCL,IGLT,IPCN,IPCL,IPLT
         COMMON/USERDT/ KEY4,DT1U,DT2U
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
         DIMENSION SAVE(22),ACONC(12)
         DINCR=DINCR2
         NTRIAL=0
         ISAV=ISTEP
         IF(ISTEP.EQ.IBED) GOTO 10
C     ..HERE IF CLOUD HAS NOT ENCOUNTERED BOTTOM....
         E1=(ROA(IY+1)-ROA(IY))/(ROA(1)*(Y(IY+1)-Y(IY)))
         EG=SQRT(E1*G)
         B1=(AA(ISTEP)**3*.84*EG/1000.)**.42857
         DT2=.001*(B1/AA(ISTEP))**3/EG*.1
         DT=DT2
         GOTO 20
C     ....HERE IF CLOUD IS ON BOTTOM....
   10    DT=DT1
   20    WRITE(6,25)
   25    FORMAT(1H1,10X,23HCOLLAPSE PHASE OF CLOUD///10X,
     1    27HCOMPUTATIONAL INDICATORS.../5X,6HNTRIAL,4X,2HDT,6X,6HIPLUNG
     2    ,2X,5HNUTRL,2X,5HISTEP,2X,4HIBED,3X,6HILEAVE)
         IF(KEY4.EQ.1) DT=DT2U
         NE=NS+10
C     SAVE STARTING VALUES IN E ARRAY...
         DO 100 KK=1,NE
  100    SAVE(KK)=E(KK)
C     ....HERE TO BEGIN A TRIAL....
  400    DO 410 KK=1,NE
  410    E(KK)=SAVE(KK)
         NTRIAL=NTRIAL+1
         ISTEP=ISAV
         VOLUME=(E(4)+E(8))/ROA(1)
         ROO=E(4)/VOLUME
         NUTRL=0
         IPLUNG=0
         IF(ISTEP.EQ.IBED) IPLUNG=1
C
C     IF CLOUD HAS HIT BOTTOM, GO DIRECTLY TO BOTTOM
         IF(ISTEP.EQ.IBED) GOTO 520
C
C     IF THIS IS FIRST TIME STEP IN COLAPS, GO DIRECTLY TO RUNGS ROUTINE.
         IF(ISTEP.EQ.ISAV) GOTO 460
C
C     ....HERE TO BEGIN MAIN COMPUTATIONAL LOOP IN TIME....
C
C     ....SAVE RESULTS OF PREVIOUS COMPUTATIONS....
  420    CX(ISTEP)=E(1)
         CY(ISTEP)=E(2)
C
C
C
C
         CZ(ISTEP)=E(3)
         VOLUME=(E(4)+E(8))/ROA(1)
         CMMASS=CM*E(4)
C     E(9) IS SEMI-MAJOR AXIS
C     BC IS HORIZONTAL DIMENSION OF CLOUD
         BC(ISTEP)=2.*E(9)
C     AA IS VERTICAL DIMENSION OF CLOUD
         AA(ISTEP)=6.*VOLUME/(PI*BC(ISTEP)**2)
         CU(ISTEP)=E(5)/CMMASS
         CV(ISTEP)=E(6)/(CMMASS*BC(ISTEP))*AA(ISTEP)
         CW(ISTEP)=E(7)/CMMASS
         ROO=E(4)/VOLUME
         ROAA=ROA(IY)+(E(2)-Y(IY))*(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         DENDIF(ISTEP)=(ROO-ROAA)*.51545
C     SS SAVE SOLID CONCENTRATION FOR DIFFUSION
         DO 430 K=1,NS
  430    SS(ISTEP,K)=E(K+10)/VOLUME
         FC(ISTEP)=VF/VOLUME
         CTRACE=(CINIT*VF+(VOLUME-VF)*CBACK)/VOLUME
         DR=CTRACE/CINIT
         IF(DR.GT.DC(ITD)) GOTO 432
         TD(ITD)=T(ISTEP)
         ITD=ITD+1
  432    CONTINUE
         IF(IPLUNG.EQ.4) GOTO 440
         IF((CY(ISTEP)+3.*AA(ISTEP)/8.).GE.H) IPLUNG=2
C
C     AKX CHANGE OF B
C     BY DIFFUSION
  440    AKX=2.*ALAMDA*(E(9))**.333333
C
C
C
         DBDT=.5*(BC(ISTEP)-BC(ISTEP-1))/DT
C     ....EXIT TESTS....
C     IF CLOUD TOUCHES FREE SURFACE, EXIT TO PRINTOUTS...
         IF(CY(ISTEP)-AA(ISTEP).LE.0.) GOTO 570
         IF(ISTEP.LE.ISAV+5) GOTO 450
C     IF CHANGE OF CLOUD MAJOR AXIS BY DIFFUSION IS GT.
C     OR EQUAL TO CHANGE IN MAJOR AXIS IN ONE TIME STEP, ATTEMPT EXIT TO BEGIN
C     LONG TERM DIFFUSION....
         IF(AKX.GE.DBDT) NUTRL=3
  450    CONTINUE
         IF(NUTRL.EQ.3) GOTO 550
C
C     IF CLOUD HIT BOTTOM WHILE COLLAPSING GO CALL BOTTOM
         IF(IPLUNG.EQ.2) GOTO 500
         IF(ISTEP.GE.599) GOTO 550
  460    CONTINUE
         ISTEP=ISTEP+1
         CALL RUNGS(DERIVC,NE,U,W,DEPTH)
         T(ISTEP)=T(ISTEP-1)+DT
         GOTO 420
C     ....END OF MAJOR LOOP....
C     ....HERE TO COMPUTE COLLAPSE ON BOTTOM....
  500    IBED=ISTEP
         DBT = E(10)*16./(PI*.5*AA(ISTEP)*.25*BC(ISTEP)**2*ROO)
         E(10)=ROO*PI*.5*AA(ISTEP)*.25*BC(ISTEP)**2
     1    *(DBT+.6666667*.5*BC(ISTEP)*CV(ISTEP)/(.5*AA(ISTEP)))/8.
  520    CALL BOTTOM(SS,U,W,DEPTH,NS,NEXT)
         GOTO (530,540,550),NEXT
  530    E(6)=CM*E(4)*CV(ISTEP)
         E(2)=CY(ISTEP)
         DBT=E(10)*8./(PI*AA(ISTEP)*.25*BC(ISTEP)**2*ROO)
C
C
C
         E(10)=ROO*PI*AA(ISTEP)*.50*BC(ISTEP)**2*DBT/16.
         ILEAVE=ISTEP
C     GO CALL RUNGS
         GOTO 460
  540    ISTEP=ISTEP-1
  550    WRITE(6,555) NTRIAL,DT,IPLUNG,NUTRL,ISTEP,IBED,ILEAVE
  555    FORMAT(5X,I4,G12.4,I6,4I7)
         IF((ISTEP-ISAV).LE.100.OR.(ISTEP-ISAV).GE.399) GOTO 560
         GOTO 570
  560    DT=DT*FLOAT(ISTEP-ISAV)*DINCR/250.
         IF(NTRIAL.GE.5) GOTO 570
C     RETURN FOR ANOTHER TRIAL
         GOTO 400
C     ....HERE FOR PRINTOUT AFTER COMPUTATIONS COMPLETED....
  570    IF(IPCL.EQ.0) GOTO 600
         WRITE(6,574)
  574    FORMAT(//10X,36HX AND Z MEASURED FROM BARGE POSITION)
         WRITE(6,575)
  575    FORMAT(/6X,4HTIME,8X,1HX,6X,1HY,6X,1HZ,9X,1HU,6X,1HV,5X,1HW,
     1    6X,7HDEN-DIF,6X,2HAA,4X,2HBC,8X,11HFLUID CONC.,3X,
     2    10HSOLID-VOL,2X,13HCONCENTRATION)
         NGRID=(ISTEP-ISAV)/60
         IF(NGRID.LT.1) NGRID=1
         DO 599 J=ISAV,ISTEP,NGRID
            DO 580 K=1,NS
  580       ACONC(K)=4.*PI*.5*AA(J)*.25*BC(J)**2*SS(J,K)/3.
            WRITE(6,585) T(J),CX(J),CY(J),CZ(J),CU(J),CV(J),CW(J),DENDIF(J),
     1       AA(J),BC(J),FC(J),ACONC(1),SS(J,1)
  585       FORMAT(1X,2F10.2,F8.2,G11.4,F6.2,F7.3,F6.2,E12.4,F7.2,G11.4,
     1       G12.4,E12.4,E12.4)
            IF(NS.EQ.1) GOTO 599
            DO 590 K=2,NS
  590       WRITE(6,595) ACONC(K),SS(J,K)
  595       FORMAT(101X,2F12.4)
  599    CONTINUE
  600    IF(IGCL.EQ.0) GOTO 700
         ISTEP1=ISTEP+1
         T(ISTEP1)=2.*T(ISTEP)-T(ISTEP-1)
         AA(ISTEP1)=0.
         CY(ISTEP1)=0.
         BC(ISTEP1)=0.
         FC(ISTEP1)=0.
         CX(ISTEP1)=2.*CX(ISTEP)-CX(ISTEP-1)
         CZ(ISTEP1)=2.*CZ(ISTEP)-CZ(ISTEP-1)
         CALL DRAW(T,T,T,T,AA,BC,FC,CY,ISTEP1,2,4)
         CALL DRAW(CX,T,T,T,CZ,T,T,T,ISTEP1,5,1)
  700    DT2=DT
         RETURN
      END
      SUBROUTINE DERIVC(E,U,W,DEPTH)
C
C
C
C
C     ....CALLED FROM COLAPS VIA RUNGS....
         DIMENSION E(22), U(1), W(1), DEPTH(1)
         COMMON/DPASS/ NPASS,MPASS
         COMMON/A/ EP(22)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GPI/ G,PI
         COMMON/SICOEF/ ALPHA,ALPHAO,ALPHAC,BETA,CDRAG,CFRIC,CD,CD1,CD2,
     1    CD3,CD4,CM,DINCR1,DINCR2,FRICTN,GAMA,F1
         COMMON/COL/ AO,IBED,FBED
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         IF(E(2).GE.0.) GOTO 30
         WRITE(6,15)
   15    FORMAT(47H Y LT 0, CHANGE INPUT DATA TO ENSURE DESCENT)
         CALL EXIT
   30    IF(E(2).LE.Y(IY+1)) GOTO 40
         IY=IY+1
         GOTO 30
   40    IF(E(2)-Y(IY)) 50,100,100
   50    IY=IY-1
         GOTO 30
  100    ROAA=ROA(IY)+(E(2)-Y(IY))*(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         CE=(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         VOLUME=(E(4)+E(8))/ROA(1)
         ROO=E(4)/VOLUME
C     B IS SEMIMAJOR AXIS
         B=E(9)
C     A IS SEMIMINOR AXIS
         A=3.*VOLUME/(4.*PI*B**2)
         ALPHA=ALPHAO*(A/B)**2
C     DETERMINE HORIZONTAL VELOCITIES AT CLOUD
         XX=XBARGE+E(1)
         ZZ=ZBARGE+E(3)
         CALL VEL(XX,E(2),ZZ,UA,WA,U,W,DEPTH,NPASS,MPASS)
         CMMASS=CM*E(4)
C
         UU=E(5)/CMMASS
         VV=E(6)/(CMMASS*B)*A
         WW=E(7)/CMMASS
C
C
         PHI=SQRT((UU-UA)**2+VV**2+(WW-WA)**2)
C     CONTRIBUTION OF COLLAPSE TO THE TIP VELOCITY OF CLOUD
         EP(9)=E(10)*16./(PI*A*B**2*ROO)
C     COMPUTE FLUID VOLUME ENTRAINED OVER SURFACE AREA OF OBLATE SPHEROID
         A1=B**2
         A2=A1
         IF(B-A) 140,140,130
  130    RT=SQRT(B**2-A**2)
         A2=.5*(A**2/RT)*ALOG((B+RT)/(B-RT))
  140    ENTRV=2.*PI*(A1+A2)*(PHI*ALPHA+ALPHAC*EP(9))
C     MAIN COMPUTATIONS
         EP(1)=UU
         EP(2)=VV
         EP(3)=WW
         EP(4)=ENTRV*ROAA
         DRAG=PI*ROAA*PHI*.5
         EP(5)=ENTRV*ROAA*UA - DRAG*A*B*(UU-UA)*CD3
         EP(6)=VOLUME*(ROO-ROAA)*G - DRAG*B**2*VV*CD4
         EP(7)=ENTRV*ROAA*WA - DRAG*A*B*(WW-WA)*CD3
         EP(8)=ENTRV*(ROA(1)-ROAA)
         EP(10)=PI*(1.-GAMA*AO/A)*CE*G*A**3*B/16.
     1    - CDRAG*ROAA*A*B*ABS(EP(9))/4.
     2    - CFRIC*ROAA*B**2*EP(9)/(2.*A)
         DV=ENTRV*ROAA
         DO 250 K=1,NS
            ABSWS=ABS(VFALL(K))
C     IF FALL VEL. IS SMALLER THAN THE CONVECTIVE VEL. NO SETTLING OCCURS
            IF(ABSWS-ABS(VV)) 220,220,230
  220       BETAA=1.
            GOTO 240
  230       BETAA=BETA
  240       SETLV=PI*B**2*ABS(VFALL(K))*(1.-BETAA)*E(K+10)/VOLUME
            EP(4)=EP(4)-SETLV*(ROAS(K))
            EP(5)=EP(5)-SETLV*(ROAS(K))*UU
            EP(6)=EP(6)-SETLV*(ROAS(K))*VV
            EP(7)=EP(7)-SETLV*(ROAS(K))*WW
            EP(8)=EP(8)-SETLV*(ROA(1)-ROAS(K))
            EP(K+10)=-SETLV
            DV=DV-SETLV*ROAS(K)
  250    CONTINUE
C
C     CONTRIBUTION OF ENTRAINMENT TO TIP VELOCITY OF CLOUD
         EP(9)=EP(9)+DV*0.375/(PI*A*B*ROO)
         RETURN
      END
      SUBROUTINE BOTTOM(SS,U,W,DEPTH,NS,NEXT)
         EXTERNAL DERIVB
         DIMENSION SS(600,NS), U(1), W(1), DEPTH(1)
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/CLOUD/ T(600),CX(600),CY(600),CZ(600),CU(600),CV(600),
     1    CW(600),DENDIF(600),BC(600),AA(600),FC(600),VF
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/GPI/ G,PI
         COMMON/SICOEF/ ALPHA,ALPHAO,ALPHAC,BETA,CDRAG,CFRIC,CD,CD1,CD2,
     1    CD3,CD4,CM,DINCR1,DINCR2,FRICTN,GAMA,F1
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         COMMON/DUMP1/ E(22)
         COMMON/COL/ AO,IBED,FBED
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
C
C
         COMMON/DTEES/ DT,DT1,DT2
         NE=10+NS
  100    VOLUME=(E(4)+E(8))/ROA(1)
C     E(9) IS SEMIMAJOR AXIS
         BC(ISTEP)=2.*E(9)
         AA(ISTEP)=3.*VOLUME/(2.*PI*E(9)**2)
         ROO=E(4)/VOLUME
         IF(ISTEP.NE.IBED) GOTO 120
         GOTO 130
C     COMPUTE INITIAL BED REACTION FORCE ON PORTION OF HEMISPHERICAL
C     CLOUD THAT HAS --PASSED THRU BOTTOM--
C
C
  110    CONTINUE
         RI = H-CY(IBED)+3.*E(9)/8.
         VB = .333333*PI*RI**2*(3.*E(9)-RI)
         FBED = FBED+VB*G*(ROO-ROA(NROA))+CM*VB*ROO*CV(IBED)/DT
         GOTO 170
C     .....START OF COMPUTATIONAL LOOP....
C
C
  120    CX(ISTEP)=E(1)
         CY(ISTEP)=H-3.*AA(ISTEP)/8.
         CZ(ISTEP)=E(3)
         CMMASS=CM*E(4)
         CU(ISTEP)=E(5)/CMMASS
         CV(ISTEP)=.75*16.*E(10)/(PI*E(9)**3*ROO)
         CW(ISTEP)=E(7)/CMMASS
         ROAA=ROA(IY)+(E(2)-Y(IY))*(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         DENDIF(ISTEP)=(ROO-ROAA)*.51545
  130    FBED=0.
         DO 160 K=1,NS
            IF(ABS(CV(ISTEP)).GT.ABS(VFALL(K))) GOTO 140
            BETAA=1.
            GOTO 150
  140       BETAA=BETA
  150       SS(ISTEP,K)=E(K+10)/VOLUME
            FBED=FBED - PI*E(9)**2*ABS(VFALL(K))*ROAS(K)*SS(ISTEP,K)*
     1       (1.-BETAA)*CV(ISTEP)
  160    CONTINUE
         IF(ISTEP.EQ.IBED) GOTO 110
         FC(ISTEP)=VF/VOLUME
         CTRACE=(CINIT*VF+(VOLUME-VF)*CBACK)/VOLUME
         DR=CTRACE/CINIT
         IF(DR.GT.DC(ITD)) GOTO 460
         TD(ITD)=T(ISTEP)
         ITD=ITD+1
C
  460    CONTINUE
         FBED=FBED + .666666*PI*AA(ISTEP)*E(9)**2*(ROO-ROAA)*G
     1    -CM*(E(4)*CV(ISTEP)-E(6)*CV(ISTEP-1))/DT
C     AKX CHANGE OF B BY DIFFUSION
         AKX=2.*ALAMDA*(E(9))**.333333
         IF(E(2).GE.H) AKX=1.0E50
         DBDT=.5*(BC(ISTEP)-BC(ISTEP-1))/DT
         IF(AKX.GE.DBDT) NUTRL=3
C
C     STORE OLD MASS IN E(6)
  170    E(6)=E(4)
         IF(FBED.LT.0.) IPLUNG=4
         IF(NUTRL.NE.3) GOTO 210
         NEXT=3
         RETURN
  210    IF(IPLUNG.NE.4) GOTO 230
         ILEAVE=ISTEP
         NEXT=1
         RETURN
  230    IF(ISTEP.LT.599) GOTO 250
         NEXT=2
         RETURN
  250    CALL RUNGS(DERIVB,NE,U,W,DEPTH)
         ISTEP=ISTEP+1
         T(ISTEP)=T(ISTEP-1)+DT
         GOTO 100
      END
      SUBROUTINE DERIVB(E,U,W,DEPTH)
C
C     ....CALLED FROM BOTTOM VIA RUNGS....
C
         DIMENSION E(22), U(1), W(1), DEPTH(1)
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         COMMON/DPASS/ NPASS,MPASS
         COMMON/A/ EP(22)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/COL/ AO,IBED,FBED
         COMMON/GPI/ G,PI
         COMMON/SICOEF/ ALPHA,ALPHAO,ALPHAC,BETA,CDRAG,CFRIC,CD,CD1,CD2,
     1    CD3,CD4,CM,DINCR1,DINCR2,FRICTN,GAMA,F1
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/DTEES/ DT,DT1,DT2
         IF(E(2).GT.H) E(2)=H
         IF(E(2).GE.0.) GOTO 30
         WRITE(6,15)
   15    FORMAT(47H Y LT 0, CHANGE INPUT DATA TO ENSURE DESCENT)
         CALL EXIT
   30    IF(E(2).LE.Y(IY+1)) GOTO 40
         IY=IY+1
         GOTO 30
   40    IF(E(2)-Y(IY)) 50,100,100
   50    IY=IY-1
         GOTO 30
  100    ROAA=ROA(IY)+(E(2)-Y(IY))*(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         CE=(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         VOLUME=(E(4)+E(8))/ROA(1)
         ROO=E(4)/VOLUME
C
C     A IS SEMIMINOR AXIS
C     B IS SEMIMAJOR AXIS
         B=E(9)
         A=3.*VOLUME/(2.*PI*B**2)
C
C
C     DETERMINE HORIZONTAL VELOCITIES AT CLOUD
         XX=XBARGE+E(1)
         ZZ=ZBARGE+E(3)
         CALL VEL(XX,E(2),ZZ,UA,WA,U,W,DEPTH,NPASS,MPASS)
C
C
C
C     CONTRIBUTION OF COLLAPSE TO TIP VELOCITY OF CLOUD
         EP(9)=E(10)*16./(PI*A*B**2*ROO)
         CMMASS=CM*E(4)
         UU=E(5)/CMMASS
         WW=E(7)/CMMASS
         PHI=SQRT((UU-UA)**2+(WW-WA)**2)
         PH=SQRT(UU**2+WW**2)
C     FOLLOWING STMTS ACCOUNT FOR UNIQUE NATURE OF BED FRICTION FORCE
C     WHICH ACTS TO OPPOSE MOTION BUT NOT TO CAUSE MOTION
C     TCOR MAKES FRICTION FORCE ACTING FOR TIME DT STOP CLOUD WHEN CLOUD
C     VELOCITY BECOMES SMALL ENOUGH.
C     STMT 130 ACTS TO KEEP FRICTION FORCE
C     ZERO AS LONG AS CLOUD IS STATIONARY.
         TCOR=1.
         IF(FBED.EQ.0.) GOTO 120
         TCK=E(4)*PH/(FBED*FRICTN)
         IF(TCK.LT.DT) TCOR=TCK/DT
  120    CONTINUE
         IF(PH.LE.0.001) GOTO 130
         GOTO 140
  130    PH=0.
         GOTO 150
  140    PH=1./PH
  150    CONTINUE
C     COMPUTE FLUID VOLUME ENTRAINED OVER SURFACE OF HALF OBLATE SPHEROID
         A1=B**2
         A2=A1
C
C
C
C     DETERMINE ENTRAINMENT COEFFICIENT AS FUNCTION OF RICHARDSON
C     NUMBER (REF. KOH AND FAN(1970), P 56)
         ALPHAR=0.
         IF(PHI.LT.1.0E-10) GOTO 160
         RI=G*(ROO-ROAA)*A/(ROAA*PHI**2)
         IF(RI.LT.0..OR.RI.GT..85) GOTO 160
         ALPHAR=.075*(2./(1.+RI/.85)-1.)**1.75
  160    IF(B-A) 180,180,170
  170    RT=SQRT(B**2-A**2)
         A2=.5*(A**2*B/RT)*ALOG((B+RT)/(B-RT))
  180    ENTRV=PI*(A1+A2)*ALPHAR*EP(9)
C     MAIN COMPUTATIONS
         EP(1)=UU
         EP(2)=0.
         EP(3)=WW
         EP(4)=ENTRV*ROAA
C
         DRAG=PI*ROAA*PHI*.5
         EP(5)=ENTRV*ROAA*UA - DRAG*A*B*(UU-UA)*CD3*.5
     1    - FBED*FRICTN*UU*PH*TCOR
         EP(6)=0.
         EP(7)=ENTRV*ROAA*WA - DRAG*A*B*(WW-WA)*CD3*.5
     1    - FBED*FRICTN*WW*PH*TCOR
         EP(8)=ENTRV*(ROA(1)-ROAA)
         EP(10)=PI*(1.-GAMA*AO/A)*CE*G*A**3*B/16.
     1    - F1*CDRAG*ROAA*A*B*ABS(EP(9))/4.
     2    - CFRIC*ROAA*B**2*EP(9)/(2.*A)
     3    - FBED*FRICTN/(2.*PI)
         DV=ENTRV*ROAA
         DO 250 K=1,NS
            ABSWS=ABS(VFALL(K))
C     IF FALL VEL. IS SMALLER THAN THE CONVECTIVE VEL. NO SETTLING OCCURS
            IF(ABSWS-ABS(EP(2))) 220,220,230
  220       BETAA=1.
            GOTO 240
  230       BETAA=BETA
  240       SETLV=PI*B**2*ABS(VFALL(K))*(1.-BETAA)*E(K+10)/VOLUME
            EP(4)=EP(4)-SETLV*(ROAS(K))
            EP(5)=EP(5)-SETLV*(ROAS(K))*UU
            EP(7)=EP(7)-SETLV*(ROAS(K))*WW
            EP(8)=EP(8)-SETLV*(ROA(1)-ROAS(K))
            EP(K+10)=-SETLV
            DV=DV-SETLV*ROAS(K)
  250    CONTINUE
C
C     CONTRIBUTION OF ENTRAINMENT TO TIP VELOCITY OF CLOUD
         EP(9)=EP(9)+DV*0.75/(PI*A*B*ROO)
         RETURN
      END
      SUBROUTINE RUNGS(DERIV,NE,U,W,D)
         COMMON/DUMP1/ E(22)
         COMMON/A/ EP(22)
         COMMON/DTEES/ DT,DT1,DT2
         DIMENSION W1(22),W2(22),W3(22),W4(22),Z(22)
         CALL DERIV(E,U,W,D)
         DO 1 I=1,NE
            W1(I)=DT*EP(I)
    1    Z(I)=E(I)+W1(I)*0.5
         CALL DERIV(Z,U,W,D)
         DO 2 I=1,NE
            W2(I)=DT*EP(I)
    2    Z(I)=E(I)+W2(I)*0.5
         CALL DERIV(Z,U,W,D)
         DO 3 I=1,NE
            W3(I)=DT*EP(I)
    3    Z(I)=E(I)+W3(I)
         CALL DERIV(Z,U,W,D)
         DO 4 I=1,NE
    4    W4(I)=DT*EP(I)
         DO 5 I=1,NE
    5    E(I)=E(I)+(2.*(W2(I)+W3(I))+W1(I)+W4(I))/6.
         RETURN
      END
      SUBROUTINE UW(ETS,U,W,NMAX,MMAX)
C
C     ROUTINE TO READ A SET OF VELOCITIES FROM TAPE. THESE VELOCITIES
C     ARE CONSTANT FOR ONE TIME STEP, DTL.
C
         DIMENSION U(NMAX,MMAX,1),W(NMAX,MMAX,1)
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/VSPECS/ IFORM,DU1,DU2,UU1,UU2,DW1,DW2,WW1,WW2,DL1,DL2
         INTEGER SKIP
         IF(IFORM.EQ.4) RETURN
         ICYCLE = ETS/90000. + 1.
         SKIP=1
C     TTAPE RELATES TAPE TIME TO ELAPSED TIME
         TTAPE = ETS+TDUMP
         TSHIFT = FLOAT(ICYCLE-1)*90000.
         TTAPE = TTAPE-TSHIFT
         IF(NVL.GT.1) GOTO 200
C     HERE FOR SINGLE LAYER
   50    READ(7) TUW
         IF((TUW+.01).LT.90000.) GOTO 70
         REWIND 7
         GOTO 50
   70    CONTINUE
         IF(ABS(TUW-TTAPE).LT..01) SKIP=0
         READ(7) ((U(N,M,1),N=1,NMAX),M=1,MMAX),
     1    ((W(N,M,1),N=1,NMAX),M=1,MMAX)
         IF(SKIP.EQ.1) GOTO 50
         RETURN
C     HERE FOR MULTI-LAYER VELOCITIES
  200    CONTINUE
  250    READ(7) TUW
         IF((TUW+.01).LT.90000.) GOTO 270
         REWIND 7
         GOTO 250
  270    CONTINUE
         IF(ABS(TUW-TTAPE).LT..01) SKIP=0
         READ(7) DL1,DL2
         DO 280 L=1,NVL
            READ(7) ((U(N,M,L),N=1,NMAX),M=1,MMAX),
     1       ((W(N,M,L),N=1,NMAX),M=1,MMAX)
  280    CONTINUE
         IF(SKIP.EQ.1) GOTO 250
         RETURN
      END
      SUBROUTINE VEL(XA,YA,ZA,UA,WA,U,W,DEPTH,NMAX,MMAX)
C
C     SUBROUTINE TO SUPPLY HORIZONTAL VELOCITY DATA, GIVEN X,Y,Z,T
C
         DIMENSION U(NMAX,MMAX,1),W(NMAX,MMAX,1),DEPTH(NMAX,1)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         COMMON/VSPECS/ IFORM,DU1,DU2,UU1,UU2,DW1,DW2,WW1,WW2,DL1,DL2
         DIMENSION UI(4),WI(4)
         IF(IFORM.EQ.4) GOTO 500
         XX=XA
         ZZ=ZA
C     DETERMINE HORIZONTAL COORDINATES OF 4 POINTS SURROUNDING (XX,ZZ) AND
C     WEIGHT FACTORS FOR INTERPOLATION
   30    ZN=ZZ*DXR
         XM=XX*DXR
         N=ZN+0.001
         M=XM+0.0001
C
C
         EN=ZN-FLOAT(N)
         EM=XM-FLOAT(M)
         IF(EN.LT..0001) EN=0.
         IF(EM.LT..0001) EM=0.
C     IF MORE THAN ONE LAYER, BRANCH
         IF(IFORM.EQ.3) GOTO 300
C     HERE TO INTERPOLATE FOR VELOCITIES IN SINGLE LAYER
         UA1 = U(N,M,1)+EN*(U(N+1,M,1)-U(N,M,1))
         WA1 = W(N,M,1)+EN*(W(N+1,M,1)-W(N,M,1))
         UA2 = U(N,M+1,1)+EN*(U(N+1,M+1,1)-U(N,M+1,1))
         WA2 = W(N,M+1,1)+EN*(W(N+1,M+1,1)-W(N,M+1,1))
         UA = UA1+EM*(UA2-UA1)
         WA = WA1+EM*(WA2-WA1)
C
C     IF USING LOG PROFILE CORRECT. VELOCITIES AS APPROPRIATE... IF NOT, RETURN
         IF(IFORM.EQ.1) GOTO 100
         CALL DINT(XX,ZZ,DD,DEPTH,NMAX)
         COR=0.
         IF(YA/DD.GT..99) GOTO 50
         COR = 1.+.476*(1.+ALOG((DD-YA)/DD))/DD**.666666
   50    CONTINUE
         UA = UA*COR
         WA = WA*COR
  100    RETURN
C
C     HERE FOR MULTI-LAYER VELOCITIES
  300    CONTINUE
         DO 380 I=1,4
            NI=N
            MI=M
            IF(I.EQ.2.OR.I.EQ.3) NI=NI+1
            IF(I.EQ.3.OR.I.EQ.4) MI=MI+1
            DD1=DL1*DEPTH(NI,MI)
            DD2=DL2*DEPTH(NI,MI)
            IF(DEPTH(NI,MI).LE.0.) GOTO 360
            IF(YA.GT.DD1) GOTO 320
            UI(I)=U(NI,MI,1)
            WI(I)=W(NI,MI,1)
            GOTO 380
  320       IF(YA.GT.DD2) GOTO 340
            FRAC=(YA-DD1)/(DD2-DD1)
            UI(I)=U(NI,MI,1)+FRAC*(U(NI,MI,2)-U(NI,MI,1))
            WI(I)=W(NI,MI,1)+FRAC*(W(NI,MI,2)-W(NI,MI,1))
            GOTO 380
  340       FRAC=(YA-DD2)/(DEPTH(NI,MI)-DD2)
            UI(I)=U(NI,MI,2)+FRAC*(0.-U(NI,MI,2))
            WI(I)=W(NI,MI,2)+FRAC*(0.-W(NI,MI,2))
            GOTO 380
  360       UI(I)=0.
            WI(I)=0.
  380    CONTINUE
         UA1=UI(1)+EN*(UI(2)-UI(1))
         WA1=WI(1)+EN*(WI(2)-WI(1))
         UA2=UI(3)+EN*(UI(4)-UI(3))
         WA2=WI(3)+EN*(WI(4)-WI(3))
         UA=UA1+EM*(UA2-UA1)
         WA=WA1+EM*(WA2-WA1)
         RETURN
C     ...HERE TO INTERPRET--QUICK LOOK-- VELOCITY PROFILES....
  500    CONTINUE
         IF(YA.LE.DU1) GOTO 510
         IF(YA.GE.DU2) GOTO 520
         UA=UU1+(UU2-UU1)*(YA-DU1)/(DU2-DU1)
         GOTO 550
  510    UA=UU1
         GOTO 550
  520    CALL DINT(XA,ZA,DD,DEPTH,NMAX)
         UA=UU2+(0.-UU2)*(YA-DU2)/(DD-DU2)
  550    CONTINUE
         IF(YA.LE.DW1) GOTO 560
         IF(YA.GE.DW2) GOTO 570
         WA=WW1+(WW2-WW1)*(YA-DW1)/(DW2-DW1)
         GOTO 600
  560    WA=WW1
         GOTO 600
  570    CALL DINT(XA,ZA,DD,DEPTH,NMAX)
         WA=WW2+(0.-WW2)*(YA-DW2)/(DD-DW2)
  600    RETURN
      END
      SUBROUTINE DRAW(X1,X2,X3,X4,Y1,Y2,Y3,Y4,N,IG,NCURV)
C
C     GRAPHING ROUTINE
C     X1,X2,X3,X4 -- INDEPENDENT VARIABLES
C     Y1,Y2,Y3,Y4 -- DEPENDENT VARIABLES
C     N -- NUMBER OF POINTS AVAILABLE FOR PLOTTING
C
         DIMENSION X1(1),X2(1),X3(1),X4(1),Y1(1),Y2(1),Y3(1),Y4(1),X(800),
     *    Y(800),YY(800),SYM(4),SIM(20),P(2400)
         DATA SIM /1HY,1HB,1HC,1HS,1HA,1H1,1H2,1H3,1H4,1H5,1H6,1H7,1H8,
     *    1HT,1HX,1HZ,1H,1H,1H,1H0/
         IF(NCURV.LT.1) RETURN
C     NX IS NUMBER OF LINES FOR INDEPENDENT VARIABLE
C     NY IS NUMBER OF COLUMNS FOR DEPENDENT VARIABLE
         NX=50
         NY=101
         NSCALE=60
         IN=N/NSCALE
         IF(IN.LT.1) IN=1
C     PLACE VARIABLES IN PLOT ARRAYS
         J=0
         DO 1 I=1,N,IN
            J=J+1
            X(J)=X1(I)
    1    Y(J)=Y1(I)
         J=J+1
         X(J)=X1(N)
         Y(J)=Y1(N)
         NN=J
         IF(NCURV.EQ.1) GOTO 5
         DO 2 I=1,N,IN
            J=J+1
            X(J)=X2(I)
    2    Y(J)=Y2(I)
         J=J+1
         X(J)=X2(N)
         Y(J)=Y2(N)
         IF(NCURV.EQ.2) GOTO 5
         DO 3 I=1,N,IN
            J=J+1
            X(J)=X3(I)
    3    Y(J)=Y3(I)
         J=J+1
         X(J)=X3(N)
         Y(J)=Y3(N)
         IF(NCURV.EQ.3) GOTO 5
         DO 4 I=1,N,IN
            J=J+1
            X(J)=X4(I)
    4    Y(J)=Y4(I)
         J=J+1
         X(J)=X4(N)
         Y(J)=Y4(N)
    5    CONTINUE
         GOTO (10,20,50,60,2000,1000,3000),IG
   10    SYM(1)=SIM(1)
         SYM(2)=SIM(2)
         SYM(3)=SIM(15)
         SYM(4)=SIM(16)
         CALL NORM(Y,YY,NN,1.0,0.,AMXY,AMNY)
         NN1=NN+1
         CALL NORM(Y(NN1),YY(NN1),NN,1.0,0.,AMXB,AMNB)
         NN1=NN1+NN
         CALL NORM(Y(NN1),YY(NN1),NN,1.0,0.,AMXC,AMNC)
         NN1=NN1+NN
C     NON-ANSI
C
         CALL NORM(Y(NN1),YY(NN1),NN,1.0,0.,AMXS,AMNS)
         WRITE(6,15) X(1),X(NN),AMXY,AMXB,AMXC,AMXS,AMNY,AMNB,AMNC,AMNS
   15    FORMAT(1H1/////10X,59HPLOT OF CLOUD PATH AND RADIUS AS SEEN FROM
     1    POINT OF RELEASE///10X,45HINDEPENDENT VARIABLE IS TIME (SEC)
     2    OVER RANGE,2X,2G13.5///10X,61HDEPENDENT VARIABLES, ALL
     3    NORMALIZED FOR PLOTTING ON UNIT AXIS//10X,6HSYMBOL,13X,1HY,
     4    17X,1HB,15X,1HX,15X,1HZ//10X,11HMAX PLOTTED,3X,G12.5,
     5    3(6X,G12.5)/10X,11HMIN PLOTTED,3X,G12.5,3(6X,G12.5)/10X,
     6    7HREMARKS,8X,5HDEPTH,13X,6HRADIUS,12X,12HHOR DIST(CX),6X,
     7    12HHOR DIST(CZ))
         CALL SPLOT(YY,X,P,J,NY,NX,NN,4,SYM)
         RETURN
   20    SYM(1)=SIM(5)
         SYM(2)=SIM(2)
         SYM(3)=SIM(3)
         SYM(4)=SIM(1)
         CALL NORM(Y,YY,NN,1.,0.,AMXA,AMNA)
C
C
C
C
C
         NN1=NN+1
         CALL NORM(Y(NN1),YY(NN1),NN,1.0,0.,AMXB,AMNB)
         NN1=NN1+NN
         CALL NORM(Y(NN1),YY(NN1),NN,1.,0.,AMXC,AMNC)
         NN1=NN1+NN
         CALL NORM(Y(NN1),YY(NN1),NN,1.0,0.,AMXY,AMNY)
         WRITE(6,25) X(1),X(NN),AMXA,AMXB,AMXC,AMXY,AMNA,AMNB,AMNC,AMNY
   25    FORMAT(1H1/////10X,40HPLOT OF COLLAPSING CLOUD CHARACTERISTICS//
     1    /10X,39HINDEPENDENT VARIABLE IS TIME OVER RANGE,2X,2G13.5///
     2    10X,60HDEPENDENT VARIABLE, ALL NORMALIZED FOR PLOTTING ON
     3    UNIT AXIS//10X,6HSYMBOL,13X,1HA,17X,1HB,13X,1HC,13X,1HY/10X,
     4    11HMAX PLOTTED,3X,G12.5,4X,3(2X,G12.5)/10X,11HMIN PLOTTED,3X,
     5    G12.5,4X,3(2X,G12.5)/10X,7HREMARKS,8X,9HVERT SIZE,9X,
     6    8HHOR SIZE,4X,12HHOR DIST(CX),4X,12HHOR DIST(CZ))
         CALL SPLOT(YY,X,P,J,NY,NX,NN,4,SYM)
         RETURN
   50    DO 51 I=1,4
   51    SYM(I)=SIM(I+5)
   52    CALL RANGE(Y,J,AMXS,AMNS,JMX,JMN)
         WRITE(6,500) X(1),X(NN),AMNS,AMXS
         CALL SPLOT(Y,X,P,J,NY,NX,NN,NCURV,SYM)
  500    FORMAT(1H1,/////,2X,31HGRAPH OF WASTE CONCENTRATIONS .//,2X,
     1    12HRANGE OF X,20X,2G20.8,2X,32HRANGE OF CONCENTRATIONS
     2    PLOTTED,2G20.8,8(/))
         RETURN
   60    DO 61 I=1,4
   61    SYM(I)=SIM(I+9)
         GOTO 52
 1000    DO 1001 I=2,4
 1001    SYM(I)=SIM(I+4)
         SYM(1)=SIM(3)
         GOTO 52
 3000    CONTINUE
         DO 3001 I=1,4
 3001    SYM(I)=SIM(I+16)
         GOTO 52
 2000    SYM(1)=SIM(15)
         CALL RANGE(Y,J,AMX,AMN,JMX,JMN)
         IF(AMN.EQ.0..AND.AMX.EQ.0.) RETURN
         WRITE(6,2001) X(1),X(NN),AMN,AMX
 2001    FORMAT(1H1,11(/),20X,15HGRAPH OF X VS Z,//,2X,10HRANGE OF X,
     1    2G20.8,/,2X,10HRANGE OF Z,2G20.8)
         CALL SPLOT(Y,X,P,J,NY,NX,NN,NCURV,SYM)
         RETURN
      END
      SUBROUTINE SPLOT(B,A,P,N,L,M,NREP,NSYM,SYM)
C
C     PRINTER PLOT ROUTINE
C     NSYM -- NUMBER OF GRAPHS PLOTTED ON THIS FRAME
C     M -- NUMBER OF SPACES DOWN THE PAGE
C     L -- NUMBER OF SPACES ACROSS THE PAGE
C
         DIMENSION A(1),B(1),SYM(1),P(1),Q(20),H(10)
         DATA Q/20*5H     /
C     NON-ANSI
         DATA BL5/5H     /
         DATA EYE/1HI/
C
C     SET GRAPH FIELD TO BLANKS
         LOLD=L
         L5=L/5
         L=5*L5
         LO=L5-1
C
C
C
         ML=(M+1)*(L5+1)
         DO 10 J=1,ML
   10    P(J)=BL5
C     DETERMINE MAX AND MIN OF INDEPENDENT VARIABLE A AND DEPENDENT
C     VARIABLE B AND THE INCREMENT OF EACH CORRESPONDING TO ONE PRINTER
C     PRINT POSITION IN EACH DIRECTION
         CALL RANGE(A,N,AMX,AMN,JMX,JMN)
         CALL RANGE(B,N,BMX,BMN,JMX,JMN)
         DIV=5.
         IF(AMX.GT.100.) DIV=10.
         IAMX=AMX/DIV
         AMX=DIV*FLOAT(IAMX)+DIV
         DA=(AMX-AMN)/FLOAT(M)
         DB=(BMX-BMN)/FLOAT(L)
         WRITE(6,2000) AMX,AMN,DA
 2000    FORMAT(/////1X,26HMAX, MIN, INC, OF IND. VAR.,1X,6G20.8)
         WRITE(6,2001) BMX,BMN,DB
 2001    FORMAT(//,1X,26HMAX, MIN, INC, OF DEP. VAR.,/1X,6G20.8)
         WRITE(6,2002)
 2002    FORMAT(1H1)
C     DETERMINE AND PRINT TOP (DEPENDENT AXIS) LABEL AND LINE
   50    JZA=0
         ZRO=0.
         TESTA=AMX*AMN
         TESTB=BMX*BMN
         IF(TESTA) 50,60,60
         JZA=-AMN/DA
   60    IF(TESTB) 70,90,90
   70    IB=-BMN/DB
         LIA=0
         DO 80 J=1,10
            LIA=LIA+L5
   80    CALL PFIX(P,IB,LIA,EYE)
   90    CONTINUE
         L10=LOLD/20+1
         DB20=20.*DB
         DO 100 J=1,L10
  100    H(J)=BMN+FLOAT(J-1)*DB20
         HMAX=ALOG10(ABS(H(L10)))+.0001
         IF(HMAX.LT.0.) GOTO 106
         IF(HMAX.GE.1.) GOTO 109
         WRITE(6,105) (H(J),J=1,L10)
  105    FORMAT(14X,F3.1,5(17X,F3.1))
         GOTO 114
  106    WRITE(6,108) (H(J),J=1,L10)
  108    FORMAT(14X,F6.4,5(14X,F6.4))
         GOTO 114
  109    WRITE(6,110) (H(J),J=1,L10)
  110    FORMAT(12X,F6.2,5(14X,F6.2))
  114    WRITE(6,115) (Q(J),J=1,20)
  115    FORMAT(15X,1HI,20A5)
C
C
C     ENCODE PLOT POINTS
         DO 200 J=1,N
            IA=(A(J)-AMN)/DA
            LIA=L5*IA
            IB=(B(J)-BMN)/DB
            JZZ=(J-1)/NREP
            ISYM = MOD(JZZ,NSYM)+1
            CALL PFIX(P,IB,LIA,SYM(ISYM))
  200    CONTINUE
C     PRINT GRAPH
         DO 300 J=1,M
            JQ=(J/10)*10
            JLO=J*L5-L5+1
            JHI=JLO+LO
            WRITE(6,255) (P(K),K=JLO,JHI)
  255       FORMAT(15X,1HI,20A5)
            IF(J.EQ.JZA) WRITE(6,265) ZRO,(Q(K),K=1,20)
  265       FORMAT(1H+,G13.5,2X,20A5)
            IF(JQ.NE.J) GOTO 300
            DAJ=AMN+DA*FLOAT(J)
            WRITE(6,265) DAJ,(Q(K),K=1,20)
  300    CONTINUE
         RETURN
      END
      SUBROUTINE RANGE(A,N,AMX,AMN,JMX,JMN)
C
C     GIVEN ARRAY A WITH N ELEMENTS, FIND MAX AND MIN VALUES AND
C     CORRESPONDING INDICES
C
         DIMENSION A(1)
         AMX=A(1)
         AMN=A(1)
         JMX=1
         JMN=1
         DO 100 J=2,N
            IF(A(J).LT.AMX) GOTO 50
            JMX=J
            AMX=A(J)
   50       CONTINUE
            IF(A(J).GT.AMN) GOTO 100
            JMN=J
            AMN=A(J)
  100    CONTINUE
         RETURN
      END
      SUBROUTINE NORM(A,B,N,C1,C2,AMX,AMN)
C
C     NORMALIZES ARRAY A WITH ARBITRARY MAX VALUE AMX, AND ARBITRARY
C     MIN VALUE AMN, INTO ARRAY B WITH MAX VALUE C1 AND MIN VALUE C2
C
         DIMENSION A(1),B(1)
         CALL RANGE(A,N,AMX,AMN,JMX,JMN)
         CC=C1-C2
         X=(AMX-AMN)/CC
         IF(X.EQ.0.) X=1.
         Y=(C1*AMN-C2*AMX)/CC
         Z=1./X
         DO 100 J=1,N
            B(J)=(A(J)-Y)*Z
  100    CONTINUE
         RETURN
      END
      SUBROUTINE PFIX(P,IB,LIA,SYM)
C
C     ROUTINE TO PLACE ALPHAMERIC CHARACTER INTO PROPER PRINT
C     POSITION IN ARRAY P
C
         DIMENSION BUF(5),P(1)
C     NON-ANSI
         IB5=IB/5
         LIB=LIA+IB5+1
         DECODE(5,1000,P(LIB)) BUF
 1000    FORMAT(5A1)
         IRES=IB-5*IB5+1
         BUF(IRES)=SYM
         ENCODE(5,1000,P(LIB)) BUF
C     NON-ANSI
         RETURN
      END
      SUBROUTINE BOOKS(K,SS,TSIDE,TTHK,TTOP,TMASS,TX,TZ,NS,DEPTH,ACCUM,
     1 U,W,NMAX,MMAX,NSC)
C
C     DUMP MODEL
C     BOOKKEEPING ROUTINE FOR MASS TRANSFER FROM SHORT TO LONG TERM
C     TAKEN ONE COMPONENT (INDEX K) AT A TIME.
C
         DIMENSION SS(600,NS),ACCUM(NMAX,1),DEPTH(NMAX,1),TSIDE(1),TTHK(1)
     1    ,TTOP(1),TMASS(1),TX(1),TZ(1),U(1),W(1)
         COMMON/NC/ NTCLD
         COMMON/CLOUD/ T(600),CX(600),CY(600),CZ(600),CU(600),CV(600),
     1    CW(600),DENDIF(600),BC(600),AA(600),FC(600),VF
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/GUIDE1/ TDUMP,TSTOP,ISTEP,IPLUNG,NUTRL,NTRIAL,ILEAVE,
     1    KEY1,KEY2,KEY3
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/COL/ AO,IBED,FBED
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         COMMON/SWITCH/ ITF
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
         NSP1=NS+1
         NTCLD=0
         C1=2.*3.14159/3.
         NEWT=1
C     INCT IS INCREMENT OF STEPS TO CHECK SHORT TERM
         INCT=ISTEP/10
         IF(K.EQ.NSP1) GOTO 300
  100    CONTINUE
         LAST=NEWT
  102    NEWT=NEWT+INCT
C     AT LAST STEP IN SHORT TERM SET TO CREATE FINAL CLOUD OF THIS
C     MATERIAL
         IF(NEWT.GT.ISTEP) NEWT=ISTEP
C     ...HERE TO CHECK IF SOLIDS HAVE LEFT CLOUD IN LATEST TIME INTERVAL
C     L IS INDICATOR OF CHANGE OF COMPUTATION PHASE DURING SHORT TERM
C     VLOSS IS SOLID VOLUME LOSS FROM CLOUD
         IF(T(NEWT).LE.T(ITF)) GOTO 120
         IF(T(LAST).GT.T(ITF)) GOTO 140
C     BETWEEN CONVECTIVE DESCENT AND DYNAMIC COLLAPSE
         VV = C1*SS(LAST,K)*AA(LAST)**3
         VLOSS = VV - .25*C1*SS(NEWT,K)*AA(NEWT)*BC(NEWT)**2
         L=2
         GOTO 200
C     IN CONVECTIVE DESCENT PHASE
  120    CONTINUE
         VV = C1*SS(LAST,K)*AA(LAST)**3
         VLOSS = VV - C1*SS(NEWT,K)*AA(NEWT)**3
         L=1
         GOTO 200
C     IN DYNAMIC COLLAPSE PHASE
  140    CONTINUE
         VV = .25*C1*SS(LAST,K)*AA(LAST)*BC(LAST)**2
         VLOSS = VV - .25*C1*SS(NEWT,K)*AA(NEWT)*BC(NEWT)**2
         L=3
  200    CONTINUE
C     AT FINAL SHORT TERM TIME STEP, VOLUME OF NEW CLOUD IS ALL
C     REMAINING MATERIAL IN CLOUD
         IF(NEWT.EQ.ISTEP) VLOSS=VV
C
C
C     IF VOLUME LOSS FOR THIS TIME INTERVAL IS ZERO, INCREMENT TO NEXT
C     TIME STEP
         IF(NEWT.EQ.ISTEP) GOTO 210
         IF(VLOSS.EQ.0.) GOTO 100
         IF((VLOSS/VV).LT.1.0E-03) GOTO 102
C
C
C     ...HERE TO CREATE SOLIDS CLOUDS...
  210    NTCLD=NTCLD+1
         IF(NTCLD.LE.NSC) GOTO 219
         WRITE(6,205)
  205    FORMAT(//10X,38HSMALL CLOUDS ARRAYS FILLED... CALL EXIT /10X,
     1    39HUSER SHOULD INCREASE INPUT VARIABLE NSC)
         CALL EXIT
  219    CONTINUE
         TMASS(NTCLD)=VLOSS
         TTHK(NTCLD)=VFALL(K)*(T(NEWT)-T(LAST))
         IF(NEWT.EQ.ISTEP) TTHK(NTCLD)=TTHK(NTCLD)+AA(ISTEP)
C
C
C     HORIZONTAL POSITION MEASUREMENT NOW TRANSLATED SO THAT IT IS W/R
C     TO ESTUARY COORDINATES
         TX(NTCLD)=CX(NEWT)+XBARGE
C
C
         TZ(NTCLD)=CZ(NEWT)+ZBARGE
         CALL DINT(TX(NTCLD),TZ(NTCLD),D3,DEPTH,NMAX)
         GOTO (220,240,240),L
  220    TTOP(NTCLD)=CY(NEWT)+3.*AA(NEWT)/8.
         IF(NEWT.EQ.ISTEP) TTOP(NTCLD)=TTOP(NTCLD)-3.*AA(NEWT)/4.
         GOTO 250
  240    TTOP(NTCLD)=CY(NEWT)+AA(NEWT)*.5
         IF(IBED.NE.0.AND.NEWT.GT.IBED.AND.NEWT.LT.ILEAVE)
     1    TTOP(NTCLD)=D3
         IF(NEWT.EQ.ISTEP) TTOP(NTCLD)=TTOP(NTCLD)-AA(NEWT)
  250    CONTINUE
         IF((TTOP(NTCLD)+TTHK(NTCLD)).GT.D3) TTOP(NTCLD)=D3-TTHK(NTCLD)
C     TSIDE IS SIDE OF SQUARE WITH AREA EQUAL TO AREA OF CIRCULAR
C     SHORT TERM CLOUD
         TSIDE(NTCLD)=.886226*BC(ISTEP)
  253    WRITE(6,255) NTCLD,T(NEWT),TX(NTCLD),TZ(NTCLD),TSIDE(NTCLD),
     1    TTOP(NTCLD),TTHK(NTCLD),TMASS(NTCLD),NEWT,LAST
  255    FORMAT(//1X,27HNEW CLOUD CREATED, NTCLD =,I5/3X,6HT(SEC),8X,2HTX
     1   ,10X,2HTZ,9X,5HTSIDE,8X,3HTOP,8X,4HTTHK,8X,5HTMASS,8X,4HNEWT,
     2    7X,4HLAST/1X,7G12.4,4X,I4,6X,I4)
         GOTO 400
C
C
C     ...HERE TO CREATE FINAL FLUID CLOUD...
  300    NTCLD=NTCLD+1
         NEWT=ISTEP
         TX(NTCLD)=CX(ISTEP)+XBARGE
         TZ(NTCLD)=CZ(ISTEP)+ZBARGE
         CALL DINT(TX(NTCLD),TZ(NTCLD),D3,DEPTH,NMAX)
         TSIDE(NTCLD)=.886226*BC(ISTEP)
         IF(ISTEP.GT.ITF) GOTO 340
         TTOP(NTCLD)=CY(ISTEP)-3.*AA(ISTEP)/8.
         TMASS(NTCLD)=FC(ISTEP)*C1*AA(ISTEP)**3
         GOTO 350
  340    TTOP(NTCLD)=CY(ISTEP)-AA(ISTEP)*.5
         IF(IBED.NE.0.AND.NEWT.GT.IBED.AND.NEWT.LT.ILEAVE)
     1    TTOP(NTCLD)=D3-AA(ISTEP)
         TMASS(NTCLD)=FC(ISTEP)*2.*C1*AA(ISTEP)*BC(ISTEP)**2/8.
  350    CONTINUE
C
         TTHK(NTCLD)=TMASS(NTCLD)/(FC(ISTEP)*TSIDE(NTCLD)**2)
         IF((TTOP(NTCLD)+TTHK(NTCLD)).GT.D3) TTOP(NTCLD)=D3-TTHK(NTCLD)
         GOTO 253
C
C     ...UPDATE LATEST CLOUD TO 1/2 HOUR AFTER DUMP
  400    DELT=DTL-T(NEWT)
C
C
C
         DTOP=0.
         CALL DINT(TX(NTCLD),TZ(NTCLD),D1,DEPTH,NMAX)
         IF(TTOP(NTCLD).EQ.D1) GOTO 410
C     ...CONVECT...
C     DETERMINE HORIZONTAL VELOCITIES
         YY=TTOP(NTCLD)+.5*TTHK(NTCLD)
         CALL VEL(TX(NTCLD),YY,TZ(NTCLD),UA,WA,U,W,DEPTH,NMAX,MMAX)
         TX(NTCLD)=TX(NTCLD)+UA*DELT
         TZ(NTCLD)=TZ(NTCLD)+WA*DELT
C     CHECK FOR SMALL CLOUD PASSING OUT OF GRID BOUNDARY
         NCHK=TZ(NTCLD)*DXR
         MCHK=TX(NTCLD)*DXR
         IF(NCHK.LT.1.OR.NCHK.GT.NMAX.OR.MCHK.LT.1.OR.MCHK.GT.MMAX)
     1    WRITE(6,405)
  405    FORMAT(/5X,101H---WARNING---A SMALL CLOUD HAS PASSED OUT OF GRID
     1    BOUNDARY IN SUBROUTINE BOOKS... ERRORS WILL OCCUR---)
         CALL DINT(TX(NTCLD),TZ(NTCLD),D2,DEPTH,NMAX)
C
C
C     DTOP ESTIMATES VARIATION OF CLOUD DEPTH DUE TO CONVECTION OVER
C     VARYING DEPTHS
         DTOP=(D1-D2)*TTOP(NTCLD)/D1.
C
C     ...DIFFUSE HORIZONTALLY...
         TSIDE(NTCLD)=TSIDE(NTCLD)*(1.+(1.333333*ALAMDA/TSIDE(NTCLD)**
     1    .666666)*DELT)**1.5
C     ...DIFFUSE VERTICALLY...
C
         OTOP=TTOP(NTCLD)
         MX=TX(NTCLD)*DXR+.5
         NZ=TZ(NTCLD)*DXR+.5
C
         CALL VDIFCO(NZ,MX,OTOP,DCO,U,W,DEPTH,NMAX,MMAX)
         DINK=2.*SQRT(DCO*DELT)
         TTOP(NTCLD)=TTOP(NTCLD)-DINK
         IF(TTOP(NTCLD).LT.0.) TTOP(NTCLD)=0.
         OBOT=OTOP+TTHK(NTCLD)
         IF(OBOT.GT.D2) OBOT=D2
         CALL VDIFCO(NZ,MX,OBOT,DCO,U,W,DEPTH,NMAX,MMAX)
         DONK=2.*SQRT(DCO*DELT)
         TTHK(NTCLD)=TTHK(NTCLD)+DINK+DONK
         IF((OTOP+TTHK(NTCLD)).GT.D2) TTHK(NTCLD)=D2-TTOP(NTCLD)
C     ...SETTLE...
  410    IF(K.EQ.NSP1) GOTO 440
         DIST=VFALL(K)*DELT
         MX=TX(NTCLD)*DXR+.5
         NZ=TZ(NTCLD)*DXR+.5
  411    XS=D2-TTOP(NTCLD)-TTHK(NTCLD)-DTOP
         IF(XS.GE.DIST) GOTO 430
         IF(XS.GE.0.) GOTO 412
         IF(TTHK(NTCLD).GT.0.) THEN
            FALOUT=ABS(XS)/TTHK(NTCLD)*TMASS(NTCLD)
            ACCUM(NZ,MX)=ACCUM(NZ,MX)+FALOUT
            TMASS(NTCLD)=TMASS(NTCLD)-FALOUT
            TTHK(NTCLD)=TTHK(NTCLD)-ABS(XS)
            GOTO 411
         ELSE
            GOTO 420
         ENDIF
  412    IF(TTHK(NTCLD).LT.(DIST-XS)) GOTO 420
         FALOUT=(DIST-XS)/TTHK(NTCLD)*TMASS(NTCLD)
         ACCUM(NZ,MX)=ACCUM(NZ,MX)+FALOUT
         TMASS(NTCLD)=TMASS(NTCLD)-FALOUT
         TTHK(NTCLD)=TTHK(NTCLD)-(DIST-XS)
         TTOP(NTCLD)=TTOP(NTCLD)+DIST-DTOP
         GOTO 440
C
  420    ACCUM(NZ,MX)=ACCUM(NZ,MX)+TMASS(NTCLD)
C     ERASE CLOUD
         TMASS(NTCLD)=0.
         TX(NTCLD)=0.
         TZ(NTCLD)=0.
         TSIDE(NTCLD)=0.
         TTHK(NTCLD)=0.
         TTOP(NTCLD)=0.
C
         NTCLD=NTCLD-1
         GOTO 440
  430    TTOP(NTCLD)=TTOP(NTCLD)+DIST-DTOP
  440    CONTINUE
         IF(K.NE.NSP1) GOTO 700
         IF(TMASS(NTCLD).LT.1.0E-10) GOTO 700
         VOLUME=TTHK(NTCLD)*TSIDE(NTCLD)**2
         CTRACE=(CINIT*VF+(VOLUME-VF)*CBACK)/VOLUME
         DR=CTRACE/CINIT
         IF(DR.GT.DC(ITD)) GOTO 700
         TD(ITD)=DTL
         ITD=ITD+1
  700    IF(NEWT.EQ.ISTEP) RETURN
         GOTO 100
      END
      SUBROUTINE ACAD(K,C,THICK,TOP,ACCUM,DEPTH,U,W,TSIDE,TTHK,TTOP,
     1 TMASS,TX,TZ,NMAX,MMAX,ETS)
C
C     DUMP MODEL
C     ROUTINE TO ANALYTICALLY CONVECT AND DIFFUSE DREDGED MATERIAL
C     CLOUDS THAT ARE TOO SMALL TO BE DEFINED BY THE NORMAL GRID.
C     IF A CLOUD GROWS BIGGER THAN STEPSIZE DX, THEN IT IS INSERTED INTO
C     NORMAL GRID.
C
         DIMENSION C(NMAX,1),THICK(NMAX,1),TOP(NMAX,1),ACCUM(NMAX,1),
     1    DEPTH(NMAX,1),TSIDE(1),TTHK(1),TTOP(1),TMASS(1),TX(1),TZ(1),
     2    U(1),W(1)
         COMMON/NC/ NTCLD
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         COMMON/LOST/ GONE
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
         COMMON/CLOUD/ T(600),CX(600),CY(600),CZ(600),CU(600),CV(600),
     1    CW(600),DENDIF(600),BC(600),AA(600),FC(600),VF
C     CHECK CLOUD FOR INJECTION TO LONG TERM GRID
         N=1
         NTEMP=NTCLD
   60    CONTINUE
C
C     CHECK CLOUD SIZE...IF LARGE ENOUGH, INJECT INTO NORMAL GRID
         IERASE=0
         IF(TMASS(N).EQ.0.) GOTO 70
C     CHECK FOR SMALL CLOUDS ON OR OUTSIDE OF GRID BOUNDARIES
         MXC=TX(N)*DXR+.0001
         NZC=TZ(N)*DXR+.0001
         IF(MXC.GT.MMAX.OR.MXC.LT.1.OR.NZC.GT.NMAX.OR.NZC.LT.1) GOTO 250
         IF(TSIDE(N).GE.2.*DX) GOTO 200
         IF(TSIDE(N).LT.DX) GOTO 100
C     ....HERE TO INJECT A SMALL CLOUD INTO THE NORMAL GRID
C     ASSIGN CLOUD MATERIAL TO FOUR NEAREST GRID POINTS
         MX=TX(N)/DX+.0001
         NZ=TZ(N)/DX+.0001
         PROPX=(TX(N)-FLOAT(MX)*DX)/DX
         IF(PROPX.LT..0001) PROPX=0.
         XMASS2=PROPX*TMASS(N)
         XMASS1=TMASS(N)-XMASS2
         PROPZ=(TZ(N)-FLOAT(NZ)*DX)/DX
         IF(PROPZ.LT..0001) PROPZ=0.
         TMASS2=PROPZ*XMASS1
         TMASS1=XMASS1-TMASS2
         TMASS4=PROPZ*XMASS2
         TMASS3=XMASS2-TMASS4
         VOL=AREA*TTHK(N)
         IF(TMASS1.EQ.0.) GOTO 61
         IF(C(NZ,MX).NE.0.) GOTO 610
C     HERE TO ADD MATL TO EMPTY GRID
         C(NZ,MX)=TMASS1/VOL
         THICK(NZ,MX)=TTHK(N)
         TOP(NZ,MX)=TTOP(N)
         GOTO 61
  610    CONTINUE
C     HERE ADD MATL TO NON-EMPTY GRID
         OM=C(NZ,MX)*THICK(NZ,MX)*AREA
C
C
C
C
C
         B1=TOP(NZ,MX)+THICK(NZ,MX)
         B2=TTOP(N)+TTHK(N)
         BOT=AMAX1(B1,B2)
         TOP(NZ,MX)=AMIN1(TOP(NZ,MX),TTOP(N))
         THICK(NZ,MX)=BOT-TOP(NZ,MX)
         C(NZ,MX)=(OM+TMASS1)/(THICK(NZ,MX)*AREA)
   61    IF(TMASS2.EQ.0.) GOTO 62
         IF(C(NZ+1,MX).NE.0.) GOTO 620
C     HERE TO ADD MATL TO EMPTY GRID
         C(NZ+1,MX)=TMASS2/VOL
         THICK(NZ+1,MX)=TTHK(N)
         TOP(NZ+1,MX)=TTOP(N)
         GOTO 62
  620    CONTINUE
C     HERE TO ADD MATL TO NON-EMPTY GRID
         OM=C(NZ+1,MX)*THICK(NZ+1,MX)*AREA
         B1=TOP(NZ+1,MX)+THICK(NZ+1,MX)
         B2=TTOP(N)+TTHK(N)
         BOT=AMAX1(B1,B2)
         TOP(NZ+1,MX)=AMIN1(TOP(NZ+1,MX),TTOP(N))
         THICK(NZ+1,MX)=BOT-TOP(NZ+1,MX)
         C(NZ+1,MX)=(OM+TMASS2)/(THICK(NZ+1,MX)*AREA)
   62    IF(TMASS3.EQ.0.) GOTO 63
         IF(C(NZ,MX+1).NE.0.) GOTO 630
C     HERE ADD MATL TO EMPTY GRID
         C(NZ,MX+1)=TMASS3/VOL
         THICK(NZ,MX+1)=TTHK(N)
         TOP(NZ,MX+1)=TTOP(N)
         GOTO 63
  630    CONTINUE
C     HERE ADD MATL TO NON-EMPTY GRID
         OM=C(NZ,MX+1)*THICK(NZ,MX+1)*AREA
         B1=TOP(NZ,MX+1)+THICK(NZ,MX+1)
         B2=TTOP(N)+TTHK(N)
         BOT=AMAX1(B1,B2)
         TOP(NZ,MX+1)=AMIN1(TOP(NZ,MX+1),TTOP(N))
         THICK(NZ,MX+1)=BOT-TOP(NZ,MX+1)
         C(NZ,MX+1)=(OM+TMASS3)/(THICK(NZ,MX+1)*AREA)
   63    IF(TMASS4.EQ.0.) GOTO 64
         IF(C(NZ+1,MX+1).NE.0.) GOTO 640
C
C     HERE ADD MATL TO EMPTY GRID
         C(NZ+1,MX+1)=TMASS4/VOL
C
         THICK(NZ+1,MX+1)=TTHK(N)
         TOP(NZ+1,MX+1)=TTOP(N)
         GOTO 64
  640    CONTINUE
C     HERE ADD MATL TO NON-EMPTY GRID
         OM=C(NZ+1,MX+1)*THICK(NZ+1,MX+1)*AREA
         B1=TOP(NZ+1,MX+1)+THICK(NZ+1,MX+1)
         B2=TTOP(N)+TTHK(N)
         BOT=AMAX1(B1,B2)
         TOP(NZ+1,MX+1)=AMIN1(TOP(NZ+1,MX+1),TTOP(N))
         THICK(NZ+1,MX+1)=BOT-TOP(NZ+1,MX+1)
         C(NZ+1,MX+1)=(OM+TMASS4)/(THICK(NZ+1,MX+1)*AREA)
   64    CONTINUE
         GOTO 70
C
C     ...HERE TO INJECT CLOUDS WITH SIDE GREATER THAN 2 DX
  200    CONTINUE
C
C     DETERMINE COORDINATES OF CORNERS
         HS=.5*TSIDE(N)
         XU=TX(N)-HS
         XD=TX(N)+HS
         ZL=TZ(N)-HS
         ZR=TZ(N)+HS
C     DETERMINE GRID SQUARES TO GET CLOUD MASS
         NL=ZL/DX+1.
         MU=XU/DX+1.
         NR=ZR/DX
         MD=XD/DX
         IF(NL.LT.1) NL=1
         IF(NR.GT.NMAX) NR=NMAX
         IF(MU.LT.1) MU=1
         IF(MD.GT.MMAX) MD=MMAX
         SIDE2=TSIDE(N)**2
         TMC=0.
         DO 220 MM=MU,MD
            DO 220 NN=NL,NR
               X1=FLOAT(MM)*DX-DXH
               IF(MM.EQ.MU) X1=XU
               X2=FLOAT(MM)*DX+DXH
               IF(MM.EQ.MD) X2=XD
               Z1=FLOAT(NN)*DX-DXH
               IF(NN.EQ.NL) Z1=ZL
               Z2=FLOAT(NN)*DX+DXH
               IF(NN.EQ.NR) Z2=ZR
               IF(C(NN,MM).NE.0.) GOTO 210
C
C     ADD MATL TO EMPTY GRID
               TOP(NN,MM)=TTOP(N)
C
C
C
C
C
               THICK(NN,MM)=TTHK(N)
               C(NN,MM)=(X2-X1)*(Z2-Z1)*TMASS(N)/(SIDE2*THICK(NN,MM)*AREA)
               GOTO 215
  210          CONTINUE
C     HERE ADD MATL TO NON-EMPTY GRID
               OM=C(NN,MM)*THICK(NN,MM)*AREA
               B1=TOP(NN,MM)+THICK(NN,MM)
               B2=TTOP(N)+TTHK(N)
               BOT=AMAX1(B1,B2)
               TOP(NN,MM)=AMIN1(TOP(NN,MM),TTOP(N))
               THICK(NN,MM)=BOT-TOP(NN,MM)
               C(NN,MM)=(OM+(X2-X1)*(Z2-Z1)/SIDE2*TMASS(N))/(THICK(NN,MM)*AREA)
  215          TMC=TMC+C(NN,MM)*THICK(NN,MM)*AREA
  220    CONTINUE
C     HERE COLLECT MASS SPILLED OUT OF BOUNDARY FROM LARGE CLOUD
         GONE=GONE+TMASS(N)-TMC
         GOTO 70
  250    CONTINUE
C     HERE COLLECT MASS PASSING THROUGH GRID BOUNDARY
         GONE=GONE+TMASS(N)
C     ERASE TRANSITION CLOUD AND MOVE CLOUDS BEHIND IT UP ONE SLOT
   70    NTEMP=NTEMP-1
         IERASE=1
         DO 80 I=N,NTEMP
            TSIDE(I)=TSIDE(I+1)
            TTHK(I)=TTHK(I+1)
            TTOP(I)=TTOP(I+1)
            TMASS(I)=TMASS(I+1)
            TX(I)=TX(I+1)
            TZ(I)=TZ(I+1)
   80    CONTINUE
C
C
C
C
         TSIDE(NTEMP+1)=0.
         TTHK(NTEMP+1)=0.
         TTOP(NTEMP+1)=0.
         TMASS(NTEMP+1)=0.
         TX(NTEMP+1)=0.
         TZ(NTEMP+1)=0.
  100    CONTINUE
         IF(IERASE.EQ.0) N=N+1
         IF(N.LE.NTEMP) GOTO 60
         NTCLD=NTEMP
         IF(NTCLD.EQ.0) RETURN
C     LOOP ONCE FOR EACH CLOUD
         DO 530 N=1,NTCLD
C     CONVECT....
C     DETERMINE HORIZONTAL VELOCITIES
            YY=TTOP(N)+.5*TTHK(N)
            CALL VEL(TX(N),YY,TZ(N),UA,WA,U,W,DEPTH,NMAX,MMAX)
            CALL DINT(TX(N),TZ(N),D1,DEPTH,NMAX)
            TX(N)=TX(N)+UA*DTL
            TZ(N)=TZ(N)+WA*DTL
C     CHECK FOR SMALL CLOUD PASSING OUT OF GRID BOUNDARY
            NCHK=TZ(N)*DXR
            MCHK=TX(N)*DXR
            IF(NCHK.LT.1.OR.NCHK.GT.NMAX.OR.MCHK.LT.1.OR.MCHK.GT.MMAX)
     1       WRITE(6,405)
  405       FORMAT(/5X,101H--WARNING-A SMALL CLOUD HAS PASSED OUT OF GRID
     1       BOUNDARY IN SUBROUTINE BOOKS...ERRORS WILL OCCUR---)
            CALL DINT(TX(N),TZ(N),D2,DEPTH,NMAX)
C
C     DTOP ESTIMATES VARIATION OF CLOUD DEPTH DUE TO CONVECTION OVER
C     VARIABLE DEPTHS
            DTOP=(D1-D2)*TTOP(N)/D1
C
C     ...DIFFUSE HORIZONTALLY...
            TSIDE(N)=TSIDE(N)*(1.+(1.333333*ALAMDA/TSIDE(N)**.666666)*DTL)
     1       **1.5
C
C     SETTLE....
            IF(K.EQ.NSP1) GOTO 500
            DIST=VFALL(K)*DTL
            MX=TX(N)*DXR+.5
            NZ=TZ(N)*DXR+.5
  411       XS=DEPTH(NZ,MX)-TTOP(N)-TTHK(N)-DTOP
            IF(XS.GE.DIST) GOTO 40
            IF(XS.GE.0.) GOTO 412
            FALOUT=ABS(XS)/TTHK(N)*TMASS(N)
            ACCUM(NZ,MX)=ACCUM(NZ,MX)+FALOUT
            TMASS(N)=TMASS(N)-FALOUT
            TTHK(N)=TTHK(N)-ABS(XS)
            GOTO 411
  412       IF(TTHK(N).LT.(DIST-XS)) GOTO 30
            FALOUT=(DIST-XS)/TTHK(N)*TMASS(N)
            ACCUM(NZ,MX)=ACCUM(NZ,MX)+FALOUT
            TMASS(N)=TMASS(N)-FALOUT
            TTHK(N)=TTHK(N)-(DIST-XS)
            TTOP(N)=TTOP(N)+DIST-DTOP
            GOTO 500
   30       ACCUM(NZ,MX)=ACCUM(NZ,MX)+TMASS(N)
            TMASS(N)=0.
            GOTO 500
   40       TTOP(N)=TTOP(N)+DIST-DTOP
  500       CONTINUE
C
C     ...DIFFUSE VERTICALLY...
            OTOP=TTOP(N)
            MX=TX(N)*DXR+.5
            NZ=TZ(N)*DXR+.5
            CALL VDIFCO(NZ,MX,OTOP,DCO,U,W,DEPTH,NMAX,MMAX)
            DINK=2.*SQRT(DCO*DTL)
            TTOP(N)=TTOP(N)-DINK
            IF(TTOP(N).LT.0.) TTOP(N)=0.
            OBOT=OTOP+TTHK(N)
            IF(OBOT.GT.DEPTH(NZ,MX)) OBOT=DEPTH(NZ,MX)
            CALL VDIFCO(NZ,MX,OBOT,DCO,U,W,DEPTH,NMAX,MMAX)
            DONK=2.*SQRT(DCO*DTL)
            TTHK(N)=TTHK(N)+DINK+DONK
            IF((OTOP+TTHK(N)).GT.DEPTH(NZ,MX)) TTHK(N)=DEPTH(NZ,MX)-TTOP(N)
  530    CONTINUE
         NTEMP=NTCLD
         L=1
  560    IF(TMASS(L).NE.0.) GOTO 570
         NTEMP=NTEMP-1
         DO 520 I=L,NTEMP
            TMASS(I)=TMASS(I+1)
            TSIDE(I)=TSIDE(I+1)
            TTHK(I)=TTHK(I+1)
            TTOP(I)=TTOP(I+1)
            TX(I)=TX(I+1)
  520    TZ(I)=TZ(I+1)
  570    IF(L.GE.NTEMP) GOTO 580
         L=L+1
         GOTO 560
  580    NTCLD=NTEMP
         IF(K.NE.NSP1) RETURN
C     CHECK FLUID DILUTION
C
         CMAX=0.
         NSAVE=1
         DO 700 N=1,NTCLD
            IF(TTHK(N).EQ.0.) GOTO 700
            CF=TMASS(N)/(TTHK(N)*TSIDE(N)**2)
            CMAX=AMAX1(CMAX,CF)
            IF(ABS(CMAX-CF).LT..0001) NSAVE=N
  700    CONTINUE
         IF(CMAX.LT.1.E-30) GOTO 460
         VOLUME=TTHK(NSAVE)*TSIDE(NSAVE)**2
         CTRACE=(CINIT*VF+(VOLUME-VF)*CBACK)/VOLUME
         DR=CTRACE/CINIT
         IF(DR.GT.DC(ITD)) GOTO 460
         TD(ITD)=ETS
         ITD=ITD+1
  460    CONTINUE
         RETURN
      END
      SUBROUTINE MAD(K,ETS,X,Z,U,W,C,THICK,TOP,DEPTH,ACCUM,CP,THICKP,
     1 TOPP,COUT,ICODE,TSIDE,TTHK,TTOP,TMASS,TX,TZ,NMAX,MMAX)
C
C     ROUTINE TO COMPUTE MOVEMENT AND DIFFUSION
C
         COMMON/DIMEN/ NS,NSP1,NVL,NSC
         DIMENSION X(NMAX,1),Z(NMAX,1),C(NMAX,1),THICK(NMAX,1),TOP(NMAX,1)
     1    ,DEPTH(NMAX,1),ACCUM(NMAX,1),CP(NMAX,1),THICKP(NMAX,1),U(1),W(1)
     2    ,TOPP(NMAX,1),COUT(NMAX,1),ICODE(NMAX,1),TMASS(1),TSIDE(1),TX(1)
     3    ,TZ(1),TTOP(1),TTHK(1)
         COMMON/GUIDE2/ NIND,NLINE(150),MF(150),ML(150)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/PIECES/ PARAM(13),ROAS(13),CS(13),VFALL(13),VOIDS(13),
     1    BVOID
         COMMON/POINT/ MST,NST
         COMMON/CHECK/ TOTAL
         COMMON/CUR/ CM,CMAX
         COMMON/NC/ NTCLD
         COMMON/LOST/ GONE
         COMMON/P/ PRT
         COMMON/FLEE/ ITD,TD(6),DC(6),TRACER,CINIT,CBACK
         LOGICAL PRT
         Q=1.0E-06
C
C
C     MOVE AND DIFFUSE SMALL CLOUDS, IF ANY
         IF(ABS(ETS-DTL).LT.0.0001) GOTO 10
         IF(NTCLD.GT.0)
     1    CALL ACAD(K,C,THICK,TOP,ACCUM,DEPTH,U,W,TSIDE,
     2    TTHK,TTOP,TMASS,TX,TZ,NMAX,MMAX,ETS)
   10    CHKM=0.
         CMAX=0.
         DO 20 M=1,MMAX
            DO 20 N=1,NMAX
               CMAX=AMAX1(CMAX,C(N,M))
   20    CHKM=CHKM+C(N,M)*THICK(N,M)*AREA
         IF(CHKM.LT.1.0E-06) GOTO 699
C
C
C     BEGIN COMPUTATIONS OVER LARGE GRID
C
         DO 100 N=1,NMAX
            DO 100 M=1,MMAX
               Z(N,M)=FLOAT(N)*DX
  100    X(N,M)=FLOAT(M)*DX
C
C
C     MOVE LOCATIONS OF POINTS WHICH TERMINATE IN THE BAY
         DO 200 NUM=1,NIND
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
C
C
            DO 200 MST=MFST,MLST
               IF(ICODE(NST,MST).GT.1) GOTO 200
C     NST AND MST ARE INDEX OF GRID POINT X(NST,MST) AND Z(NST,MST)
C     ARE COORDINATES OF LOCATION OF THIS PARTICLE AT START OF
C     CONVECTIVE STEP
               YY=TOP(NST,MST)+.5*THICK(NST,MST)
               CALL TRNSPT(Z(NST,MST),X(NST,MST),YY,U,W,DEPTH,ICODE,NMAX,MMAX)
  200    CONTINUE
C
C     CLEAR ARRAYS
         DO 320 M=1,MMAX
            DO 320 N=1,NMAX
               CP(N,M)=0.
               THICKP(N,M)=0.
  320    TOPP(N,M)=0.
C
C
C     COMPUTE NEW CONCENTRATIONS FOR ALL POINTS IN BAY
         CM=0.
         DO 510 NUM=1,NIND
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 510 MST=MFST,MLST
               ZN=Z(NST,MST)*DXR
               XM=X(NST,MST)*DXR
               N=ZN+.0001
               M=XM+.0001
               EN=ZN-FLOAT(N)
               EM=XM-FLOAT(M)
               IF(EN.LT.0.0001) EN=0.
               IF(EM.LT.0.0001) EM=0.
               EN1=1.-EN
               EM1=1.-EM
               ISUM=0
               CALL AVESPT(N,M,C1,TH1,T1,ISUM,0,C,THICK,TOP,ICODE,NMAX,
     1          DEPTH(N,M))
               CALL AVESPT(N+1,M,C2,TH2,T2,ISUM,1,C,THICK,TOP,ICODE,NMAX,
     1          DEPTH(N+1,M))
               CALL AVESPT(N+1,M+1,C3,TH3,T3,ISUM,2,C,THICK,TOP,ICODE,NMAX,
     1          DEPTH(N+1,M+1))
               CALL AVESPT(N,M+1,C4,TH4,T4,ISUM,3,C,THICK,TOP,ICODE,NMAX,
     1          DEPTH(N,M+1))
               CP(NST,MST)=0.
               THICKP(NST,MST)=0.
               TOPP(NST,MST)=0.
               TN = AMAX1(TH1,TH2,TH3,TH4)
               IF(TN.EQ.0.) GOTO 500
               C1=C1*TH1/TN
               C2=C2*TH2/TN
               C3=C3*TH3/TN
               C4=C4*TH4/TN
               THICKP(NST,MST)=TN
               GOTO (401,402,403,404,405,406,407,408,409,410,411,412,413,414,
     1          415),ISUM
  401          CP(NST,MST)=C1
               TOPP(NST,MST)=T1
               GOTO 500
  402          CP(NST,MST)=C2
               TOPP(NST,MST)=T2
               GOTO 500
  404          CP(NST,MST)=C3
               TOPP(NST,MST)=T3
               GOTO 500
  408          CP(NST,MST)=C4
               TOPP(NST,MST)=T4
               GOTO 500
  403          CP(NST,MST)=(C2-C1)*EN+C1
               TOPP(NST,MST)=(T2-T1)*EN+T1
               IF(T1.LT.0..OR.T2.LT.0.) TOPP(NST,MST)=AMAX1(T1,T2)
               GOTO 500
  412          CP(NST,MST)=(C3-C4)*EN+C4
               TOPP(NST,MST)=(T3-T4)*EN+T4
               IF(T3.LT.0..OR.T4.LT.0.) TOPP(NST,MST)=AMAX1(T3,T4)
               GOTO 500
  406          CP(NST,MST)=(C3-C2)*EM+C2
               TOPP(NST,MST)=(T3-T2)*EM+T2
               IF(T2.LT.0..OR.T3.LT.0.) TOPP(NST,MST)=AMAX1(T2,T3)
               GOTO 500
  409          CP(NST,MST)=(C4-C1)*EM+C1
               TOPP(NST,MST)=(T4-T1)*EM+T1
               IF(T1.LT.0..OR.T4.LT.0.) TOPP(NST,MST)=AMAX1(T1,T4)
               GOTO 500
  405          IF(EN*EM-.25) 401,421,404
  421          CP(NST,MST)=.5*(C1+C3)
               TOPP(NST,MST)=.5*(T1+T3)
               IF(T1.LT.0..OR.T3.LT.0.) TOPP(NST,MST)=AMAX1(T1,T3)
               GOTO 500
  410          IF(EN-EM) 408,422,402
  422          CP(NST,MST)=.5*(C2+C4)
               TOPP(NST,MST)=.5*(T2+T4)
               IF(T2.LT.0..OR.T4.LT.0.) TOPP(NST,MST)=AMAX1(T2,T4)
               GOTO 500
  407          AD=EN1+EM
               IF(AD.EQ.0.0) GOTO 402
               CP(NST,MST)=(EN1*((C2-C1)*EN+C1)+EM*((C3-C2)*EM+C2))/AD
               TOP1=(T2-T1)*EN+T1
               IF(T1.LT.0..OR.T2.LT.0.) TOP1=AMAX1(T1,T2)
               TOP2=(T3-T2)*EM+T2
               IF(T2.LT.0..OR.T3.LT.0.) TOP2=AMAX1(T2,T3)
               TOPP(NST,MST)=(EN1*TOP1+EM*TOP2)/AD
               IF(TOP1.LT.0..OR.TOP2.LT.0.) TOPP(NST,MST)=AMAX1(TOP1,TOP2)
               GOTO 500
  411          AD=EN+EM
               IF(AD.EQ.0.0) GOTO 401
               CP(NST,MST)=(EN*((C2-C1)*EN+C1)+EM*((C4-C1)*EM+C1))/AD
               TOP1=(T2-T1)*EN+T1
               IF(T1.LT.0..OR.T2.LT.0.) TOP1=AMAX1(T1,T2)
               TOP2=(T4-T1)*EM+T1
               IF(T1.LT.0..OR.T4.LT.0.) TOP2=AMAX1(T1,T4)
               TOPP(NST,MST)=(EN*TOP1+EM*TOP2)/AD
               IF(TOP1.LT.0..OR.TOP2.LT.0.) TOPP(NST,MST)=AMAX1(TOP1,TOP2)
               GOTO 500
  413          AD=EN+EM1
               IF(AD.EQ.0.0) GOTO 408
               CP(NST,MST)=(EN*((C3-C4)*EN+C4)+EM1*((C4-C1)*EM+C1))/AD
               TOP1=(T3-T4)*EN+T4
               IF(T3.LT.0..OR.T4.LT.0.) TOP1=AMAX1(T3,T4)
               TOP2=(T4-T1)*EM+T1
               IF(T1.LT.0..OR.T4.LT.0.) TOP2=AMAX1(T1,T4)
               TOPP(NST,MST)=(EN*TOP1+EM1*TOP2)/AD
               IF(TOP1.LT.0..OR.TOP2.LT.0.) TOPP(NST,MST)=AMAX1(TOP1,TOP2)
               GOTO 500
  414          AD=EN1+EM1
               IF(AD.EQ.0.0) GOTO 404
               CP(NST,MST)=(EN1*((C3-C4)*EN+C4)+EM1*((C3-C2)*EM+C2))/AD
               TOP1=(T3-T4)*EN+T4
               IF(T3.LT.0..OR.T4.LT.0.) TOP1=AMAX1(T3,T4)
               TOP2=(T3-T2)*EM+T2
               IF(T2.LT.0..OR.T3.LT.0.) TOP2=AMAX1(T2,T3)
               TOPP(NST,MST)=(EN1*TOP1+EM1*TOP2)/AD
               IF(TOP1.LT.0..OR.TOP2.LT.0.) TOPP(NST,MST)=AMAX1(TOP1,TOP2)
               GOTO 500
  415          CONE=(C2-C1)*EN+C1
               CTWO=(C3-C4)*EN+C4
               CP(NST,MST)=(CTWO-CONE)*EM+CONE
               TOP1=(T2-T1)*EN+T1
               IF(T1.LT.0..OR.T2.LT.0.) TOP1=AMAX1(T1,T2)
               TOP2=(T3-T4)*EN+T4
               IF(T3.LT.0..OR.T4.LT.0.) TOP2=AMAX1(T3,T4)
               TOPP(NST,MST)=(TOP2-TOP1)*EM+TOP1
               IF(EM.LT.0.0001) GOTO 500
               IF(TOP1.LT.0..OR.TOP2.LT.0.) TOPP(NST,MST)=AMAX1(TOP1,TOP2)
  500          IF(CP(NST,MST).GT.1.E-20) GOTO 510
               CP(NST,MST)=0.
               THICKP(NST,MST)=0.
               TOPP(NST,MST)=0.
  510    CONTINUE
         DO 2000 NUM=1,NIND
            NST=NLINE(NUM)
C
C
C
C
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 2000 MST=MFST,MLST
               DDTHK=TOPP(NST,MST)+THICKP(NST,MST)-DEPTH(NST,MST)
               IF(DDTHK.LE.0.) GOTO 2000
               OTHK=THICKP(NST,MST)
               THICKP(NST,MST)=THICKP(NST,MST)-DDTHK
               CP(NST,MST)=CP(NST,MST)*OTHK/THICKP(NST,MST)
 2000    CONTINUE
C     SHIFT ARRAYS AND ADD MASS LOST BY DIFFUSION LIMITING IN AVESPT
C     TO POINT OF MAXIMUM CONCENTRATION
         CMAX=0.
         C1=0.
         C2=0.
         NCOR=1
         MCOR=1
         DO 550 NUM=1,NIND
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 550 MST=MFST,MLST
               CMAX=AMAX1(CMAX,CP(NST,MST))
               IF(CMAX.NE.CP(NST,MST)) GOTO 520
               NCOR=NST
               MCOR=MST
  520          CONTINUE
               C1=C1+C(NST,MST)*THICK(NST,MST)*AREA
               C(NST,MST)=CP(NST,MST)
               THICK(NST,MST)=THICKP(NST,MST)
               C2=C2+C(NST,MST)*THICK(NST,MST)*AREA
C     DTOP ESTIMATES VARIATION OF CLOUD DEPTH DUE TO CONVECTION OVER
C     VARIABLE DEPTHS
               CALL DINT(X(NST,MST),Z(NST,MST),DD1,DEPTH,NMAX)
               DTOP=(DD1-DEPTH(NST,MST))*TOPP(NST,MST)/DD1
  550    TOP(NST,MST)=TOPP(NST,MST)-DTOP
         GONE=GONE+C1-C2
         IF(CMAX.LT.1.E-20) GOTO 560
C
C     ADD MASS LOST BY DIFFUSION LIMITING
         C(NCOR,MCOR)=C(NCOR,MCOR)+CM/(THICK(NCOR,MCOR)*AREA)
C
C
         GONE=GONE-CM
  560    CONTINUE
C     SETTLE SOLIDS....
         IF(VFALL(K).EQ.0.) GOTO 690
C
C
         DIST=VFALL(K)*DTL
         DO 680 NUM=1,NIND
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 680 MST=MFST,MLST
               IF(C(NST,MST).EQ.0..OR.ICODE(NST,MST).GT.1) GOTO 680
  611          XS=DEPTH(NST,MST)-TOP(NST,MST)-THICK(NST,MST)
               IF(XS.GE.DIST) GOTO 640
               IF(XS.GE.0.) GOTO 612
               FALOUT=ABS(XS)*C(NST,MST)*AREA
               ACCUM(NST,MST)=ACCUM(NST,MST)+FALOUT
               THICK(NST,MST)=THICK(NST,MST)-ABS(XS)
               GOTO 611
  612          IF(THICK(NST,MST).LT.(DIST-XS)) GOTO 630
               FALOUT=(DIST-XS)*C(NST,MST)*AREA
               ACCUM(NST,MST)=ACCUM(NST,MST)+FALOUT
               THICK(NST,MST)=THICK(NST,MST)-(DIST-XS)
               TOP(NST,MST)=TOP(NST,MST)+DIST
               GOTO 680
  630          CONTINUE
               ACCUM(NST,MST)=ACCUM(NST,MST)+THICK(NST,MST)*AREA*C(NST,MST)
               C(NST,MST)=0.
               TOP(NST,MST)=DEPTH(NST,MST)
               THICK(NST,MST)=0.
               GOTO 680
  640          CONTINUE
               TOP(NST,MST)=TOP(NST,MST)+DIST
  680    CONTINUE
  690    CONTINUE
C     VERTICAL DIFFUSION...
         DO 600 NUM=1,NIND
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 600 MST=MFST,MLST
               IF(C(NST,MST).LT.1.0E-20) GOTO 600
               IF(THICK(NST,MST).EQ.0.) GOTO 600
               OTHICK=THICK(NST,MST)
               OTOP=TOP(NST,MST)
               CALL VDIFCO(NST,MST,OTOP,DCO,U,W,DEPTH,NMAX,MMAX)
               DINK=2.*SQRT(DCO*DTL)
               IF(TOP(NST,MST).GT.0.) TOP(NST,MST)=TOP(NST,MST)-DINK
               IF(TOP(NST,MST).LT.0.) TOP(NST,MST)=0.
C
               OBOT=OTOP+THICK(NST,MST)
               IF(OBOT.GT.DEPTH(NST,MST)) OBOT=DEPTH(NST,MST)
               CALL VDIFCO(NST,MST,OBOT,DCO,U,W,DEPTH,NMAX,MMAX)
               DONK=2.*SQRT(DCO*DTL)
               OBOT=OBOT+DONK
               IF(OBOT.GT.DEPTH(NST,MST)) OBOT=DEPTH(NST,MST)
               THICK(NST,MST)=OBOT-TOP(NST,MST)
               C(NST,MST)=C(NST,MST)*OTHICK/THICK(NST,MST)
  600    CONTINUE
C     CHECK FLUID DILUTION
         IF(K.NE.NSP1) GOTO 698
         CMAX2=0.
         DO 696 NUM=1,NIND
C
C
C
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 696 MST=MFST,MLST
               IF(C(NST,MST).LT.CMAX2) GOTO 696
               CMAX2=C(NST,MST)
               NSTSV=NST
               MSTSV=MST
  696    CONTINUE
         IF(CMAX2.LT.1.E-30) GOTO 698
         VOLUME=THICK(NSTSV,MSTSV)*DX**2
         VN=CMAX2*VOLUME
         CTRACE=(CINIT*VN+(VOLUME-VN)*CBACK)/VOLUME
         DR=CTRACE/CINIT
         IF(DR.GT.DC(ITD)) GOTO 698
         TD(ITD)=ETS
         ITD=ITD+1
  698    CONTINUE
C     CHECK FOR MASS CONSERVATION
  699    TNORM=0.
         TACCUM=0.
         DO 704 NUM=1,NIND
            NST=NLINE(NUM)
            MFST=MF(NUM)
            MLST=ML(NUM)
            DO 704 MST=MFST,MLST
               TACCUM=TACCUM+ACCUM(NST,MST)
  704    TNORM=TNORM+C(NST,MST)*THICK(NST,MST)*AREA
         TRANS=0.
         IF(NTCLD.LT.1) GOTO 710
         DO 708 I=1,NTCLD
  708    TRANS=TRANS+TMASS(I)
  710    TOTAL=TNORM+TRANS
         WRITE(6,712) PARAM(K),ETS,TOTAL,TNORM,TRANS,TACCUM
  712    FORMAT(/////5X,11HSUMMARY OF,A10,21H DISTRIBUTIONS AFTER,
     1    F10.2,6H SEC. /5X,34HTOTAL SUSPENDED MATERIAL (CUFT) =,G14.5/
     2    5X,46HSUSPENDED MATERIAL IN LONG TERM GRID (CUFT) =,G14.5/
     3    5X,44HSUSPENDED MATERIAL IN SMALL CLOUDS (CUFT) =,G14.5/
     4    5X,42HTOTAL MATERIAL SETTLED TO BOTTOM (CUFT) =,G14.5//
     5    5X,55HOUTPUT SUPPRESSED IN LOCATIONS WITH NO MATERIAL PRESENT)
         IF(ABS(GONE).GT.1.) WRITE(6,715) GONE
  715    FORMAT(/10X,G12.5,72H CUFT OF MATERIAL (CUMULATIVE) LOST BY
     1    PASSING THROUGH GRID BOUNDARIES)
         IF(.NOT.PRT) RETURN
C
C     PRINT RESULTS IF REQUESTED BY INPUT DATA
         IF(TNORM.LT.1.0E-06) GOTO 725
  719    CONTINUE
         DO 720 M=1,MMAX
            DO 720 N=1,NMAX
  720    COUT(N,M)=C(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,1,ICODE)
         DO 770 M=1,MMAX
            DO 770 N=1,NMAX
  770    COUT(N,M)=TOP(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,3,ICODE)
         DO 780 M=1,MMAX
            DO 780 N=1,NMAX
  780    COUT(N,M)=THICK(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,4,ICODE)
  725    IF(K.EQ.NSP1) GOTO 760
         IF(TACCUM.LT.1.0E-06) GOTO 760
         DO 730 M=1,MMAX
            DO 730 N=1,NMAX
  730    COUT(N,M)=ACCUM(N,M)
         CALL PRINTC(COUT,NMAX,MMAX,PARAM(K),ETS,2,ICODE)
  760    CONTINUE
         IF(NTCLD.EQ.0) RETURN
         WRITE(6,805) ETS
  805    FORMAT(18H1 SMALL CLOUDS AT,F10.2,21H SECONDS ELAPSED TIME //
     1    2X,1HN,7X,1HX,13X,1HZ,11X,5HTMASS,9X,5HTSIDE,10X,4HTTHK,9X,
     2    4HTTOP)
         WRITE(6,815) (N,TX(N),TZ(N),TMASS(N),TSIDE(N),TTHK(N),TTOP(N),
     1    N=1,NTCLD)
  815    FORMAT(1X,I2,1X,6G14.4)
         RETURN
      END
      SUBROUTINE TRNSPT(ZZ,XX,YY,U,W,DEPTH,ICODE,NMAX,MMAX)
         DIMENSION ICODE(NMAX,1),U(1),W(1),DEPTH(1)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/POINT/ MST,NST
         N=ZZ*DXR+.5
         M=XX*DXR+.5
C
C     DETERMINE VELOCITIES
         CALL VEL(XX,YY,ZZ,UA,WA,U,W,DEPTH,NMAX,MMAX)
         XX=XX-UA*DTL
         ZZ=ZZ-WA*DTL
         NE=ZZ*DXR+.5
         ME=XX*DXR+.5
C
C     CHECK THAT MARKER PARTICLE DOES NOT COME FROM OUT OF BOUNDS
         IF(NE.GT.0) GOTO 1
         NE=1
         ZZ=FLOAT(NE)*DX
    1    IF(NE.LE.NMAX) GOTO 2
         NE=NMAX
         ZZ=FLOAT(NE)*DX
    2    IF(ME.GT.0) GOTO 3
         ME=1
         XX=FLOAT(ME)*DX
    3    IF(ME.LE.MMAX) GOTO 4
         ME=MMAX
         XX=FLOAT(ME)*DX
    4    CONTINUE
         ITMP=ICODE(NE,ME)
         IF(ITMP.NE.2) GOTO 50
         ZZ=FLOAT(N)*DX
         XX=FLOAT(M)*DX
   50    RETURN
      END
      SUBROUTINE AVESPT(N,M,CONC,THK,XTOP,ISUM,J,C,THICK,TOP,ICODE,NMAX
     1,DCENT)
C
C
C     ROUTINE TO AVERAGE CONCENTRATIONS IN A 5 POINT STAR PATTERN
C     DIFFUSION LIMITED FROM THOSE POINTS WITH CONCENTRATIONS LESS
C     THAN EPSLN.
C     MASS LOST IN CONSEQUENCE IS ADDED IN ROUTINE
C     MAD TO POINT OF MAXIMUM CONCENTRATION.
C
         DIMENSION C(NMAX,1),THICK(NMAX,1),TOP(NMAX,1),ICODE(NMAX,1)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/CUR/ CM,CMAX
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         EPSLN=2.0E-05*CMAX
         COCEAN=0.
         IF(ICODE(N,M)-2) 1,2,3
    2    CONC=0.0
         XTOP=0.
         THK=0.
         RETURN
    3    CONC=COCEAN
         XTOP=0.
         THK=0.
         GOTO 200
    1    C1=C(N,M)
         T1=TOP(N,M)
         TH1=THICK(N,M)
         IF(C1.GT.EPSLN) GOTO 7
         CM=CM+C1*TH1*AREA
         C1=0.
         C(N,M)=0.
         TOP(N,M)=0.
         THICK(N,M)=0.
    7    CONTINUE
         C2=C(N-1,M)
         T2=TOP(N-1,M)
         TH2=DCENT-T2
         IF(TH2.LT.0.) TH2=0.
         IF(TH2.GT.THICK(N-1,M)) TH2=THICK(N-1,M)
         IF(C2.GT.EPSLN) GOTO 9
         CM=CM+C2*THICK(N-1,M)*AREA
         C2=0.
         C(N-1,M)=0.
         TOP(N-1,M)=0.
         THICK(N-1,M)=0.
    9    CONTINUE
         IF(ICODE(N-1,M).NE.2) GOTO 10
         C2=C1
         T2=T1
         TH2=TH1
   10    IF(ICODE(N-1,M).NE.3) GOTO 20
         C2=COCEAN
         T2=T1
         TH2=TH1
   20    C3=C(N+1,M)
         T3=TOP(N+1,M)
         TH3=DCENT-T3
         IF(TH3.LT.0.) TH3=0.
         IF(TH3.GT.THICK(N+1,M)) TH3=THICK(N+1,M)
         IF(C3.GT.EPSLN) GOTO 27
C
C
         CM=CM+C3*THICK(N+1,M)*AREA
         C3=0.
         C(N+1,M)=0.
         TOP(N+1,M)=0.
         THICK(N+1,M)=0.
   27    CONTINUE
         IF(ICODE(N+1,M).NE.2) GOTO 30
         C3=C1
         T3=T1
         TH3=TH1
   30    IF(ICODE(N+1,M).NE.3) GOTO 40
         C3=COCEAN
         T3=T1
         TH3=TH1
C
   40    C4=C(N,M+1)
C
C
C
         T4=TOP(N,M+1)
         TH4=DCENT-T4
         IF(TH4.LT.0.) TH4=0.
         IF(TH4.GT.THICK(N,M+1)) TH4=THICK(N,M+1)
         IF(C4.GT.EPSLN) GOTO 47
         CM=CM+C4*THICK(N,M+1)*AREA
         C4=0.
         C(N,M+1)=0.
         TOP(N,M+1)=0.
         THICK(N,M+1)=0.
   47    CONTINUE
         IF(ICODE(N,M+1).NE.2) GOTO 50
         C4=C1
         T4=T1
         TH4=TH1
   50    IF(ICODE(N,M+1).NE.3) GOTO 60
         C4=COCEAN
         T4=T1
         TH4=TH1
   60    C5=C(N,M-1)
         T5=TOP(N,M-1)
         TH5=DCENT-T5
         IF(TH5.LT.0.) TH5=0.
         IF(TH5.GT.THICK(N,M-1)) TH5=THICK(N,M-1)
         IF(C5.GT.EPSLN) GOTO 67
         CM=CM+C5*THICK(N,M-1)*AREA
         C5=0.
         C(N,M-1)=0.
         TOP(N,M-1)=0.
         THICK(N,M-1)=0.
   67    CONTINUE
         IF(ICODE(N,M-1).NE.2) GOTO 70
         C5=C1
         T5=T1
         TH5=TH1
   70    IF(ICODE(N,M-1).NE.3) GOTO 80
         C5=COCEAN
         T5=T1
         TH5=TH1
   80    CONTINUE
C     SET THICKNESS AND TOP OF NEW ELEMENT TO AVERAGE OF CONTRIBUTING ELEMENTS
         INUM=0
C
         TOPSUM=0.
         IF(TH1.EQ.0.) GOTO 83
         INUM=INUM+1
         TOPSUM=TOPSUM+T1
   83    IF(TH2.EQ.0.) GOTO 84
         INUM=INUM+1
         TOPSUM=TOPSUM+T2
   84    IF(TH3.EQ.0.) GOTO 86
         INUM=INUM+1
         TOPSUM=TOPSUM+T3
   86    IF(TH4.EQ.0.) GOTO 88
         INUM=INUM+1
         TOPSUM=TOPSUM+T4
   88    IF(TH5.EQ.0.) GOTO 92
         INUM=INUM+1
         TOPSUM=TOPSUM+T5
   92    IF(INUM.EQ.0) GOTO 190
         THK=AMAX1(TH1,TH2,TH3,TH4,TH5)
         XTOP=TOPSUM/FLOAT(INUM)
         IF(XTOP+THK.GT.DCENT) XTOP=DCENT-THK
C     5 POINT AVERAGING FOLLOWS
         CEF1=C1*TH1/THK
         CEF2=C2*TH2/THK
         CEF3=C3*TH3/THK
         CEF4=C4*TH4/THK
         CEF5=C5*TH5/THK
         CONC=CEF1 - DIF*(4.*CEF1 - (CEF2+CEF3+CEF4+CEF5))
         GOTO 200
  190    CONTINUE
         CONC=0.
         THK=0.
         XTOP=0.
  200    ISUM = ISUM + 2**J
         RETURN
      END
      SUBROUTINE PRINTC(OUT,NMX,MMX,PARAM,ET,LBL,ICODE)
         DIMENSION OUT(NMX,MMX),ICODE(NMX,MMX)
         DIMENSION IPR(128),NUM(10)
         DATA IB,LND,ISEA,IPLUS,IDOT /1H ,1HL,1HO,1H+,1H./
         DATA NUM(1),NUM(2),NUM(3),NUM(4),NUM(5),NUM(6),NUM(7),NUM(8),
     1    NUM(9),NUM(10) /1H0,1H1,1H2,1H3,1H4,1H5,1H6,1H7,1H8,1H9/
C     SCALE ARRAY FOR OPTIMUM PRINTOUT
         PMAX=0.
         DO 50 M=1,MMX
            DO 50 N=1,NMX
   50    PMAX=AMAX1(PMAX,OUT(N,M))
         P10=1.
         IP10=1
         IF(PMAX.GT.0.) IP10=ALOG10(PMAX)
         IF(IP10.GE.3) P10=10.**(IP10-2)
         IF(IP10.LT.0) P10=10.**(IP10-1)
         DO 60 M=1,MMX
            DO 60 N=1,NMX
   60    OUT(N,M)=OUT(N,M)/P10
         GOTO (150,200,250,300,350,400,450),LBL
  150    WRITE(6,155) PARAM,ET
  155    FORMAT(19H1CONCENTRATIONS OF,A10,29H (VOLUME RATIO) IN THE CLOUD,
     1    F10.2,19H SECONDS AFTER DUMP)
         GOTO 500
  200    WRITE(6,215) PARAM,ET
  215    FORMAT(24H1BOTTOM ACCUMULATION OF,A10,
     1    20H (CUFT/GRID SQUARE),F10.2,19H SECONDS AFTER DUMP)
         GOTO 500
  250    WRITE(6,255) PARAM,ET
  255    FORMAT(20H1POSITION OF TOP OF,A10,
     1    28H CLOUD (FEET BELOW SURFACE),F10.2,19H SECONDS AFTER DUMP)
         GOTO 500
  300    WRITE(6,305) PARAM,ET
  305    FORMAT(14H1THICKNESS OF,A10,14H CLOUD (FEET),F10.2,
     1    19H SECONDS AFTER DUMP)
         GOTO 500
  350    WRITE(6,355) PARAM,ET
  355    FORMAT(19H1THICKNESS (FT) OF,A10,24H ACCUMULATED ON BOTTOM,
     1    F10.2,19H SECONDS AFTER DUMP)
         GOTO 500
  400    WRITE(6,405) ET
  405    FORMAT(59H1TOTAL ACCUMULATED SOLID VOLUME ON BOTTOM (CUFT/GRID
     1    SQR),F10.2,19H SECONDS AFTER DUMP)
         GOTO 500
  450    WRITE(6,455) ET
  455    FORMAT(48H1TOTAL THICKNESS (FT) OF NEW MATERIAL ON BOTTOM,
     1    F10.2,19H SECONDS AFTER DUMP)
  500    CONTINUE
         WRITE(6,505) P10
  505    FORMAT(33H... MULTIPLY DISPLAYED VALUES BY,G11.4,5X,
     1    60H(LEGEND... .LT. .01, +.LT. .0001, O.LT. .000001))
C
C
C     SET UP PAGE DIVISIONS FOR PRINTING OF ARRAY
         NCP=NMX/32+1
C
         IF(((NCP-1)*32).EQ.NMX) NCP=NCP-1
         IN2=0
         DO 1000 IP=1,NCP
            IN1=IN2+1
            IN2=IN2+32
            IF(NMX.LT.IN2) IN2=NMX
            WRITE(6,605) (N,N=IN1,IN2,4)
  605       FORMAT(2X,5HM(N=),31I4)
            DO 100 M=1,MMX
               DO 10 I=1,128
   10          IPR(I)=IB
               DO 1 N=IN1,IN2
                  J=4*(N-IN1+1)
                  L=OUT(N,M)+.5
                  IF(ICODE(N,M).EQ.2) GOTO 2
                  IF(ICODE(N,M).EQ.3) GOTO 7
                  IF(L.GE.1000) GOTO 6
                  IF(L.GE.100) GOTO 3
                  IF(L.GE.10) GOTO 4
                  IF(OUT(N,M).GE.1.) GOTO 30
                  IF(OUT(N,M).LT.1.0E-06) GOTO 25
                  IF(OUT(N,M).LT..0001) GOTO 18
                  IF(OUT(N,M).LT..01) GOTO 8
                  IF(OUT(N,M).LT..1) GOTO 20
                  IPR(J-2)=NUM(1)
                  N1=10.*OUT(N,M)
                  IPR(J-1)=NUM(N1+1)
                  N2=100.*OUT(N,M)-10.*FLOAT(N1)
                  IPR(J)=NUM(N2+1)
                  GOTO 1
   30             LF=OUT(N,M)
                  LL=10.*(OUT(N,M)-FLOAT(LF))
                  IPR(J)=NUM(LL+1)
                  IPR(J-1)=IDOT
                  IPR(J-2)=NUM(LF+1)
                  GOTO 1
   25             IPR(J)=NUM(1)
                  GOTO 1
   20             IPR(J-2)=IDOT
                  IPR(J-1)=NUM(1)
                  N2=100.*OUT(N,M)
                  IPR(J)=NUM(N2+1)
                  GOTO 1
    2             IPR(J)=LND
                  IPR(J-1)=LND
                  IPR(J-2)=LND
                  IPR(J-3)=LND
                  GOTO 1
    7             IPR(J)=ISEA
                  IPR(J-1)=ISEA
                  IPR(J-2)=ISEA
                  IPR(J-3)=ISEA
                  GOTO 1
    6             N1=L/1000
                  IPR(J-3)=NUM(N1+1)
                  N1=L-1000*N1
                  N2=N1/100
                  IPR(J-2)=NUM(N2+1)
                  N2=N1-100*N2
                  N3=N2/10
                  IPR(J-1)=NUM(N3+1)
                  N1=N2-10*N3
                  IPR(J)=NUM(N1+1)
                  GOTO 1
    3             N1=L/100
                  IPR(J-2)=NUM(N1+1)
                  N1=L-100*N1
                  N2=N1/10
                  IPR(J-1)=NUM(N2+1)
                  N1=N1-10*N2
                  IPR(J)=NUM(N1+1)
                  GOTO 1
    4             N1=L/10
                  IPR(J-1)=NUM(N1+1)
                  N1=L-10*N1
                  IPR(J)=NUM(N1+1)
                  GOTO 1
    8             IPR(J)=IPLUS
                  GOTO 1
   18             IPR(J)=IDOT
    1          CONTINUE
               WRITE(6,205) M,IPR
  205          FORMAT(/1X,I3,1X,128A1)
  100       CONTINUE
            IF(IP.LT.NCP) WRITE(6,705)
  705       FORMAT(1H1//)
 1000    CONTINUE
         RETURN
      END
      SUBROUTINE DINT(XD,ZD,DEP,DEPTH,NMAX)
C
C     ROUTINE TO INTERPOLATE ON DEPTH GRID FOR DEPTH AT AN ARBITRARY
C     POINT IN THE ESTUARY
C     GIVEN POSITION (XD,ZD) IN ESTUARY COORDINATES, RETURNS DEPTH (DEP)
C
         DIMENSION DEPTH(NMAX,1)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         ZN=ZD*DXR
         XM=XD*DXR
         N=ZN+0.0001
         M=XM+0.0001
         EN=ZN-FLOAT(N)
         EM=XM-FLOAT(M)
         IF(EN.LT.0.0001) EN=0.
         IF(EM.LT.0.0001) EM=0.
         D1=DEPTH(N,M)+EN*(DEPTH(N+1,M)-DEPTH(N,M))
         D2=DEPTH(N,M+1)+EN*(DEPTH(N+1,M+1)-DEPTH(N,M+1))
         DEP=D1+EM*(D2-D1)
         RETURN
      END
      SUBROUTINE VDIFCO(N,M,YY,AKY,U,W,DEPTH,NMAX,MMAX)
C
C     ROUTINE TO COMPUTE VERTICAL DIFFUSION COEFFICIENTS
C
         DIMENSION DEPTH(NMAX,1),U(NMAX,MMAX,1),W(NMAX,MMAX,1)
         COMMON/BAY/ DX,DTL,XBARGE,ZBARGE,DXH,DXR,AREA
         COMMON/GPI/ G,PI
         COMMON/LTCOF/ ALAMDA,DIF,AKYO
         COMMON/AMB/ NROA,IY,Y(10),ROA(10),H
C     DETERMINE DENSITY AND VELOCITY GRADIENTS
         IY=0
   10    IY=IY+1
         IF(IY+1 .GT. NROA) GOTO 20
         IF(YY.GE.Y(IY).AND.YY.LE.Y(IY+1)) GOTO 20
         GOTO 10
   20    RHO=ROA(IY)+(ROA(IY+1)-ROA(IY))*(YY-Y(IY))/(Y(IY+1)-Y(IY))
         DENGRA=(ROA(IY+1)-ROA(IY))/(Y(IY+1)-Y(IY))
         Y1=YY+1.
         Y2=YY-1.
         XX=FLOAT(M)*DX
         ZZ=FLOAT(N)*DX
         CALL VEL(XX,Y1,ZZ,UA1,WA1,U,W,DEPTH,NMAX,MMAX)
         CALL VEL(XX,Y2,ZZ,UA2,WA2,U,W,DEPTH,NMAX,MMAX)
         VELGRA=SQRT((UA2-UA1)**2+(WA2-WA1)**2)/2.
         IF(VELGRA.NE.0.) GOTO 40
C
C
C
C
C     USE PRITCHARD DEFINITION OF RICHARDSON NO.
         CALL VEL(XX,0.,ZZ,UA1,WA1,U,W,DEPTH,NMAX,MMAX)
         VELGRA=0.7*SQRT(UA1**2+WA1**2)/DEPTH(N,M)
C     DETERMINE RICHARDSON NO.
         IF(VELGRA.NE.0.) GOTO 40
         AKY=0.
         RETURN
   40    RI=G*DENGRA/(RHO*VELGRA**2)
C     CHECK BOUNDS
         IF(RI.LT.0.) RI=0.
         IF(RI.GT.3.999999) RI=3.999999
C     COMPUTE DIFFUSION COEFFICIENT
         AKY=AKYO*(1.-0.25*RI)
         RETURN
      END
